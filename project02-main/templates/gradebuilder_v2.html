<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Builder v2 - E-Class Record</title>
    <meta name="theme-color" content="#6b7280">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gradebuilder_v2.css') }}">
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-brand">
                <h1>Grade Builder v2</h1>
                <span class="header-subtitle">E-Class Record</span>
            </div>
            <div class="header-nav">
                <nav class="main-nav">
                    <a href="{{ url_for('dashboard.instructor_dashboard') }}" class="nav-link">Dashboard</a>
                    <a href="{{ url_for('instructor.instructor_classes') }}" class="nav-link">Classes</a>
                    <a href="{{ url_for('instructor.gradebuilder_v2') }}" class="nav-link active">Grade Builder</a>
                    <a href="#" class="nav-link">Reports</a>
                </nav>
            </div>
            <div class="header-user">
                <div class="user-info">
                    <div class="user-avatar">GB</div>
                    <div class="user-details">
                        <span class="user-name">Grade Builder</span>
                        <span class="user-role">Structure Management</span>
                    </div>
                </div>
                <a href="{{ url_for('dashboard.instructor_dashboard') }}" class="back-btn">Back to Dashboard</a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-container">
            <!-- Left Sidebar - 40% -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h2 class="section-title">Saved Structures</h2>
                    <div id="structure-list" class="structure-list" role="list" aria-label="Saved structures">
                        <!-- populated by JS as clickable items -->
                    </div>
                    <div class="sidebar-actions">
                        <button id="new-structure-btn" class="btn btn-primary">+ New Structure</button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h2 class="section-title">Structure Details</h2>
                    <div class="detail-panel">
                        <label class="detail-label">Structure Name:
                            <input id="structure-name" type="text" value="New Structure" placeholder="Enter structure name" />
                        </label>
                        <label class="detail-label">For Class:
                            <select id="class-select" class="class-list">
                                <option value="">(select class)</option>
                            </select>
                        </label>
                        <button id="save-btn" class="btn btn-primary">Save Structure</button>
                    
                    </div>
                </div>

                <div class="sidebar-section">
                    <h2 class="section-title">Tips & Help</h2>
                    <div class="help-panel">
                        <ul class="help-list">
                            <li>Subcategory weights inside each category must sum to 100%.</li>
                            <li>Assessments are created on the Grade Entry page.</li>
                            <li>Use clear, descriptive names for your structures.</li>
                            <li>Save frequently to avoid losing work.</li>
                        </ul>
                    </div>
                </div>
            </aside>

            <!-- Right Main Content - 60% -->
            <section class="main-section">
                <div class="editor-section" id="main-content">
                    <div class="editor-header">
                        <h2>Grade Structure Editor</h2>
                        <div class="editor-actions">
                            <button class="btn btn-secondary" id="clear-fields-btn">Clear Fields</button>
                            <button class="btn btn-secondary" id="cancel-edit-btn">Cancel Edit</button>
                            <button class="btn btn-secondary" id="preview-btn">Preview</button>
                        </div>
                    </div>

                    <div class="editor-body">
                        <div class="column lab">
                            <div class="column-header">
                                <h3>LABORATORY</h3>
                                <small>(must sum to 100%)</small>
                            </div>
                            <div class="small-actions">
                                <button id="lab-add" class="btn btn-primary">Add Subcategory</button>
                                <span id="lab-sum" class="percent">Total: 0%</span>
                            </div>
                            <div id="lab-list" class="sub-list"></div>
                        </div>

                        <div class="column lecture">
                            <div class="column-header">
                                <h3>LECTURE</h3>
                                <small>(must sum to 100%)</small>
                            </div>
                            <div class="small-actions">
                                <button id="lecture-add" class="btn btn-primary">Add Subcategory</button>
                                <span id="lecture-sum" class="percent">Total: 0%</span>
                            </div>
                            <div id="lecture-list" class="sub-list"></div>
                        </div>
                    </div>

                    <div class="preview-section">
                        <h3>Preview</h3>
                        <div class="preview-box" id="preview-box">
                            No preview yet. Add subcategories to see the structure.
                        </div>
                    </div>

                    <div class="sticky-actions">
                        <button id="save-btn-bottom" class="btn btn-primary">Save Structure</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Template for subcategories -->
    <template id="sub-template">
        <div class="sub-item">
            <input data-field="name" placeholder="Subcategory name" />
            <input data-field="weight" type="number" min="0" max="100" step="0.01" placeholder="0" />
            <button data-action="remove" class="btn btn-ghost">Remove</button>
        </div>
    </template>

    <!-- Confirmation modal -->
    <div id="confirm-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirm-modal-title">Confirm action</h3>
                <button class="close" onclick="closeConfirmModal()" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message">Are you sure?</p>
            </div>
            <div class="modal-actions">
                <button id="confirm-cancel" class="btn">Cancel</button>
                <button id="confirm-ok" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/swal.js') }}"></script>
    <script src="{{ url_for('static', filename='js/gradebuilder_v2.js') }}"></script>
    
    <script>
        // Additional script for save button highlighting based on lab/lecture totals
        document.addEventListener('DOMContentLoaded', function() {
            const saveBtn = document.getElementById('save-btn');
            const saveBtnBottom = document.getElementById('save-btn-bottom');
            const detailPanel = document.querySelector('.detail-panel');
            
            // Monitor the existing updateSaveEnabled function and enhance it
            const originalUpdateSaveEnabled = window.updateSaveEnabled;
            
            window.updateSaveEnabled = function() {
                // Call the original function if it exists
                if (typeof originalUpdateSaveEnabled === 'function') {
                    originalUpdateSaveEnabled();
                }
                
                // Get current totals from existing logic
                const labList = document.getElementById('lab-list');
                const lectureList = document.getElementById('lecture-list');
                
                if (labList && lectureList) {
                    // Calculate lab total
                    let labTotal = 0;
                    let labCount = 0;
                    labList.querySelectorAll('.sub-item').forEach(item => {
                        const weightInput = item.querySelector('input[data-field="weight"]');
                        if (weightInput && weightInput.value) {
                            labTotal += parseFloat(weightInput.value) || 0;
                            labCount++;
                        }
                    });
                    
                    // Calculate lecture total
                    let lectureTotal = 0;
                    let lectureCount = 0;
                    lectureList.querySelectorAll('.sub-item').forEach(item => {
                        const weightInput = item.querySelector('input[data-field="weight"]');
                        if (weightInput && weightInput.value) {
                            lectureTotal += parseFloat(weightInput.value) || 0;
                            lectureCount++;
                        }
                    });
                    
                    // Check if either lab or lecture meets 100%
                    const tol = 0.001;
                    const labIs100 = Math.abs(labTotal - 100) <= tol;
                    const lectureIs100 = Math.abs(lectureTotal - 100) <= tol;
                    const hasOneComplete = (labCount > 0 && labIs100) || (lectureCount > 0 && lectureIs100);
                    
                    // Enable/disable save buttons with neon green styling
                    [saveBtn, saveBtnBottom].forEach(btn => {
                        if (btn) {
                            if (hasOneComplete) {
                                btn.disabled = false;
                                btn.classList.add('enabled');
                            } else {
                                btn.disabled = true;
                                btn.classList.remove('enabled');
                            }
                        }
                    });
                    
                    // Toggle detail panel highlighting
                    if (detailPanel) {
                        if (hasOneComplete) {
                            detailPanel.classList.add('save-ready');
                        } else {
                            detailPanel.classList.remove('save-ready');
                        }
                    }
                }
            };
            
            // Override the existing updateTotalDisplay function to also trigger save state updates
            const originalUpdateTotalDisplay = window.updateTotalDisplay;
            window.updateTotalDisplay = function() {
                if (typeof originalUpdateTotalDisplay === 'function') {
                    originalUpdateTotalDisplay();
                }
                // Trigger save state update after totals are updated
                setTimeout(() => {
                    if (typeof window.updateSaveEnabled === 'function') {
                        window.updateSaveEnabled();
                    }
                }, 50);
            };
            
            // Initial call to set up the state
            setTimeout(() => {
                if (typeof window.updateSaveEnabled === 'function') {
                    window.updateSaveEnabled();
                }
            }, 100);
        });
    </script>
</body>

</html>