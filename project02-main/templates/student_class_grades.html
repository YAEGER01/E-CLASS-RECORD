
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Grades</title>
    <link rel="stylesheet" href="/static/css/student-dashboard.css">
    <style>
        body {
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 2rem;
            color: #14532d;
        }
        .header p {
            margin: 4px 0 0 0;
            color: #64748b;
            font-size: 1rem;
        }
        .nav-back {
            margin-top: 12px;
        }
        .nav-back a {
            background: #16a34a;
            color: #fff;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 6px 18px rgba(22, 163, 74, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .nav-back a:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 24px rgba(22, 163, 74, 0.22);
        }
        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .classes-card {
            padding: 0;
        }
        .classes-card header {
            padding: 16px 20px 12px 20px;
            border-bottom: 1.5px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            flex-wrap: wrap;
            gap: 12px;
        }
        .classes-card header h2 {
            margin: 0;
            font-size: clamp(1.25rem, 2vw, 1.6rem);
            color: #14532d;
        }
        .classes-card header span {
            color: #64748b;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .classes-card .table-wrapper {
            padding: 12px 16px 20px 16px;
            overflow-x: auto;
        }
        .alert {
            color: #fff;
            background: #d9534f;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 1rem;
        }
        .assessment-box {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 6px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }
        .assessment-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        .assessment-score {
            font-size: 1rem;
        }
        .grade-summary {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        .grade-summary h3 {
            margin: 0 0 8px 0;
            color: #14532d;
        }
        .grade-summary p {
            margin: 4px 0;
            color: #14532d;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ðŸ“Š Class Grades</h1>
            <p>Detailed breakdown of your performance</p>
        </div>
        <div class="nav-back">
            <a href="/student/classes">âŸµ Back to Classes</a>
        </div>
    </div>

    <div class="classes-grid">
        <div class="card classes-card">
            <header>
                <h2>Grade Details</h2>
                <span id="class-info">Loading...</span>
            </header>
            <div class="table-wrapper">
                <div id="grade-details">
                    <p>Loading grades...</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const classId = "{{ class_id }}";
            const container = document.getElementById('grade-details');
            const classInfo = document.getElementById('class-info');
            container.innerHTML = `<p>Loading latest matching snapshot data...</p>`;
            fetch(`/api/student/classes/${classId}/grades`)
                .then(response => response.json())
                .then(data => {
                    if (data.message === "No Snapshots") {
                        container.innerHTML = `<div class='alert'>No grade snapshots available for this class or student.</div>`;
                        classInfo.textContent = 'No Data';
                        return;
                    }
                    if (data.error) {
                        container.innerHTML = `<div class='alert'>${data.error}</div>`;
                        classInfo.textContent = 'Error';
                        return;
                    }
                    classInfo.textContent = `${data.course || 'Unknown'} - Section ${data.section || 'N/A'}`;
                    let html = `<div class="grade-summary">
                        <h3>Grade Summary</h3>
                        <p><strong>Final Grade:</strong> ${data.final_grade !== null ? data.final_grade + '%' : 'Pending'}</p>
                        <p><strong>Equivalent:</strong> ${data.equivalent !== null ? data.equivalent : 'N/A'}</p>
                    </div>`;
                    if (data.details && data.details.scores && data.details.structure_json) {
                        html += `<h4>Grade Breakdown</h4>`;
                        const structure = data.details.structure_json;
                        const scores = data.details.scores;
                        // Map assessment_id to score
                        const scoreMap = {};
                        scores.forEach(s => { scoreMap[s.assessment_id] = s.score; });
                        for (const [category, subcats] of Object.entries(structure)) {
                            html += `<h5>${category}</h5>`;
                            let hasAssessments = false;
                            subcats.forEach(subcat => {
                                if (subcat.assessments && Array.isArray(subcat.assessments) && subcat.assessments.length > 0) {
                                    hasAssessments = true;
                                    subcat.assessments.forEach(assessment => {
                                        const score = assessment.released_score !== undefined && assessment.released_score !== null ? assessment.released_score : 'N/A';
                                        const maxScore = assessment.max_score !== undefined ? assessment.max_score : '';
                                        const color = assessment.color || 'black';
                                        html += `<div class="assessment-box">
                                            <div class="assessment-name">${assessment.name}</div>
                                            <div class="assessment-score">Score: <strong style="color: ${color}">${score}</strong> / ${maxScore}</div>
                                        </div>`;
                                    });
                                }
                            });
                            if (!hasAssessments) {
                                html += `<div class="assessment-box" style="background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                                    <div class="assessment-name">No Assessments</div>
                                    <div class="assessment-score">No assessments available for ${category.toLowerCase()}.</div>
                                </div>`;
                            }
                        }
                    }
                    container.innerHTML = html;
                })
                .catch(err => {
                    container.innerHTML = `<div class='alert'>Failed to load grades. Please try again later.</div>`;
                    classInfo.textContent = 'Error';
                });
        });
    </script>
</body>
</html>
