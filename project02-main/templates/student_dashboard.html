<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - E-Class Record</title>
    <script src="{{ url_for('static', filename='js/swal.js') }}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/student-dashboard.css') }}">
</head>

<body>
    <div class="header">
        <h1>üéì Student Dashboard</h1>
        <p>Welcome, {{ user.school_id }}!</p>
    <a href="{{ url_for('auth.logout') }}" class="logout-btn">Logout</a>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">üìö My Profile</h3>
                <button onclick="editProfile()" id="editProfileBtn" style="background:#16a34a; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:600;">‚úèÔ∏è Edit</button>
            </div>

            <div style="display:flex; align-items:center; margin-top:12px;">
                {# Prefer stored static paths (face_photo_path), then any photo/photo_path fields, then external URL, finally default image. Use onerror to fallback to default if file missing. #}
                {% if user.student_profile.face_photo_path %}
                <img id="profilePhoto" src="{{ url_for('static', filename=user.student_profile.face_photo_path) }}" data-default="{{ url_for('static', filename='images/default-profile.svg') }}" alt="Profile Photo" onerror="this.onerror=null;this.src=this.dataset.default;" style="width:72px; height:72px; object-fit:cover; border-radius:8px; margin-right:12px; border:1px solid #e5e7eb;">
                {% elif user.student_profile.photo_path %}
                <img id="profilePhoto" src="{{ url_for('static', filename=user.student_profile.photo_path) }}" data-default="{{ url_for('static', filename='images/default-profile.svg') }}" alt="Profile Photo" onerror="this.onerror=null;this.src=this.dataset.default;" style="width:72px; height:72px; object-fit:cover; border-radius:8px; margin-right:12px; border:1px solid #e5e7eb;">
                {% elif user.student_profile.photo %}
                <img id="profilePhoto" src="{{ url_for('static', filename=user.student_profile.photo) }}" data-default="{{ url_for('static', filename='images/default-profile.svg') }}" alt="Profile Photo" onerror="this.onerror=null;this.src=this.dataset.default;" style="width:72px; height:72px; object-fit:cover; border-radius:8px; margin-right:12px; border:1px solid #e5e7eb;">
                {% elif user.student_profile.photo_url %}
                <img id="profilePhoto" src="{{ user.student_profile.photo_url }}" data-default="{{ url_for('static', filename='images/default-profile.svg') }}" alt="Profile Photo" onerror="this.onerror=null;this.src=this.dataset.default;" style="width:72px; height:72px; object-fit:cover; border-radius:8px; margin-right:12px; border:1px solid #e5e7eb;">
                {% else %}
                <img id="profilePhoto" src="{{ url_for('static', filename='images/default-profile.svg') }}" data-default="{{ url_for('static', filename='images/default-profile.svg') }}" alt="Profile Photo" style="width:72px; height:72px; object-fit:cover; border-radius:8px; margin-right:12px; border:1px solid #e5e7eb;">
                {% endif %}
                <div>
                    <p style="margin:0;"><strong>School ID:</strong> <span id="schoolIdSpan">{{ user.school_id }}</span></p>
                    <p style="margin:4px 0 0 0;"><strong>Course:</strong> <span id="courseSpan">{{ user.student_profile.course }}</span></p>
                    <p style="margin:4px 0 0 0;"><strong>Year Level:</strong> <span id="yearLevelSpan">{{ user.student_profile.year_level }}</span></p>
                    <p style="margin:4px 0 0 0;"><strong>Section:</strong> <span id="sectionSpan">{{ user.student_profile.section }}</span></p>
                    {% if user.student_profile.track %}
                    <p style="margin:4px 0 0 0;"><strong>Track:</strong> <span id="trackSpan">{{ user.student_profile.track }}</span></p>
                    {% else %}
                    <p style="margin:4px 0 0 0; color:#6b7280; font-style:italic;"><em id="trackSpan">No track set</em></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üöÄ JOIN CLASS</h3>
            <p>Enter a class join code to enroll in a new class.</p>
            <div style="margin-top: 15px;">
                <input type="text" id="joinCode" placeholder="Enter 6-digit join code" maxlength="6"
                    style="padding: 8px; width: 200px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                <button onclick="joinClass()" class="join-btn">üöÄ Join Class</button>
            </div>
            <div id="joinMessage" style="margin-top: 10px; display: none;"></div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h3 style="margin: 0;">üìö Joined Classes</h3>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Your enrolled classes</p>
                </div>
                <div id="classCount" style="color: #16a34a; font-weight: bold; font-size: 18px;">0</div>
            </div>

            <!-- Collapsible Class List -->
            <div id="joinedClassesList" style="margin-top: 15px;">
                <p style="color: #666; font-style: italic;">Loading classes...</p>
            </div>

            <!-- Expand/Collapse Button -->
            <button id="toggleClassesBtn" onclick="toggleClassList()" style="display: none; margin-top: 15px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%; font-size: 14px;">
                üìñ View All Classes
            </button>
        </div>

        <div class="card">
            <h3>üìä Grades</h3>
            <p>View your academic performance.</p>
            <p><em>Feature coming soon...</em></p>
        </div>
            <div class="card">
                <h3>üìù My Classes Table</h3>
                <p>View all your joined classes in a table format.</p>
                <a href="{{ url_for('student.student_classes') }}" class="view-table-btn" style="display:inline-block; background:#2563eb; color:#fff; padding:10px 20px; border-radius:6px; text-decoration:none; font-weight:600; margin-top:10px;">View Classes Table</a>
            </div>
    </div>

    <!-- Class Details Modal -->
    <div id="classModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0;">üìö Class Details</h3>
                <button onclick="closeModal()"
                    style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
            </div>
            <div id="classDetails" style="line-height: 1.6;">
                <!-- Class details will be populated here -->
            </div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: right;">
                <button id="leaveClassBtn" onclick="confirmLeaveClass()"
                    style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Leave Class
                </button>
            </div>
        </div>
    </div>

    <template id="swal_edit_profile_template" hidden>
        <style>
            .swal-edit-profile {
                width: min(760px, calc(100vw - 18px)) !important;
                max-width: 760px !important;
                height: clamp(520px, 75vh, 700px) !important;
                padding: 0 !important;
                border-radius: 20px !important;
                display: flex !important;
                flex-direction: column;
                box-sizing: border-box;
                backdrop-filter: blur(6px);
                top: calc(3vh + 16px) !important;
                margin: 16px auto !important;
            }
            @media (max-height: 640px) {
                .swal-edit-profile {
                    top: calc(2vh + 12px) !important;
                    height: 88vh !important;
                    max-height: 620px !important;
                }
            }
            .swal-edit-scroll {
                flex: 1;
                overflow-y: auto;
                padding: 24px 28px 36px;
                box-sizing: border-box;
                background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            }
            .swal-edit-scroll::-webkit-scrollbar { width: 6px; }
            .swal-edit-scroll::-webkit-scrollbar-thumb { background: rgba(148,163,184,0.45); border-radius: 999px; }
            .swal-edit-scroll::-webkit-scrollbar-track { background: transparent; }
            .swal-edit-actions {
                position: sticky;
                bottom: 0;
                width: 100%;
                margin: 0 !important;
                padding: 14px 28px 24px;
                background: linear-gradient(180deg, rgba(248,250,252,0.92) 0%, #e2e8f0 100%);
                border-top: 1px solid #dbeafe;
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                z-index: 3;
            }
            .swal-edit-confirm,
            .swal-edit-cancel {
                min-width: 120px;
                border-radius: 10px;
                font-weight: 600;
                font-size: 0.95rem;
                padding: 10px 18px;
                border: 1.5px solid transparent;
                transition: all 0.2s ease;
            }
            .swal-edit-confirm {
                background: #16a34a;
                color: #fff;
                box-shadow: 0 8px 20px rgba(22,163,74,0.18);
            }
            .swal-edit-confirm:hover {
                background: #15803d;
                box-shadow: 0 10px 26px rgba(22,163,74,0.22);
            }
            .swal-edit-cancel {
                background: #fff;
                color: #0f172a;
                border-color: #cbd5f5;
            }
            .swal-edit-cancel:hover {
                background: #f8fafc;
                border-color: #94a3b8;
            }
            .swal-register-grid {
                display: grid;
                grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
                gap: 18px;
                align-items: start;
                max-width: 100%;
                box-sizing: border-box;
            }
            .swal-register-left {
                text-align: center;
                background: rgba(241,245,249,0.6);
                border-radius: 14px;
                padding: 16px 12px;
                border: 1px solid #e2e8f0;
            }
            .swal-photo-zone {
                border: 1.5px dashed #cbd5f5;
                padding: 10px;
                border-radius: 10px;
                cursor: pointer;
                transition: border-color 0.2s ease, background 0.2s ease;
                background: #fff;
            }
            .swal-photo-zone:hover {
                border-color: #16a34a;
                background: #f0fdf4;
            }
            .swal-photo-preview {
                width: 120px;
                height: 120px;
                object-fit: cover;
                border-radius: 10px;
                border: 1px solid #e2e8f0;
                display: block;
                margin: 0 auto 12px;
            }
            .swal-field { margin-bottom: 10px; }
            .swal-field label {
                display: block;
                font-size: 12px;
                color: #334155;
                margin-bottom: 4px;
                font-weight: 600;
                letter-spacing: 0.02em;
            }
            .swal-field input,
            .swal-field select {
                width: 100%;
                padding: 9px 10px;
                border-radius: 8px;
                border: 1px solid #cbd5f5;
                box-sizing: border-box;
                font-size: 0.94rem;
            }
            .swal-field input:focus,
            .swal-field select:focus {
                outline: none;
                border-color: #16a34a;
                box-shadow: 0 0 0 3px rgba(22,163,74,0.15);
            }
            .swal-field-row {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .swal-field-row .swal-field { flex: 1 1 160px; min-width: 0; }
            @media (max-width: 900px) {
                .swal-edit-scroll {
                    padding: 22px 22px 30px;
                }
                .swal-register-grid {
                    grid-template-columns: 1fr;
                }
                .swal-register-left {
                    order: -1;
                    padding: 14px 10px;
                }
            }
            @media (max-width: 620px) {
                .swal-edit-profile {
                    width: calc(100vw - 12px) !important;
                    max-width: 560px !important;
                    height: 92vh !important;
                    max-height: none !important;
                    top: calc(1.5vh + 12px) !important;
                    margin: 12px auto !important;
                }
                .swal-edit-scroll {
                    padding: 18px 16px 28px;
                }
                .swal-edit-actions {
                    padding: 12px 18px 18px;
                    flex-direction: column-reverse;
                    align-items: stretch;
                }
                .swal-edit-confirm,
                .swal-edit-cancel {
                    width: 100%;
                    min-width: 0;
                }
                .swal-register-left {
                    padding: 12px 8px;
                }
                .swal-photo-preview {
                    width: 104px;
                    height: 104px;
                }
                .swal-field input,
                .swal-field select {
                    font-size: 0.92rem;
                }
            }
            @media (max-width: 420px) {
                .swal-edit-scroll {
                    padding: 16px 12px 24px;
                }
                .swal-photo-preview {
                    width: 96px;
                    height: 96px;
                }
                .swal-photo-zone {
                    padding: 8px;
                }
                .swal-field input,
                .swal-field select {
                    padding: 8px;
                }
            }
        </style>

        <div class="swal-edit-scroll">
            <div class="swal-register-grid">
            <div class="swal-register-left">
                {% if user.student_profile.face_photo_path %}
                <img id="swalPhotoPreview" src="{{ url_for('static', filename=user.student_profile.face_photo_path) }}" class="swal-photo-preview" alt="Face Preview">
                {% elif user.student_profile.face_photo_url %}
                <img id="swalPhotoPreview" src="{{ user.student_profile.face_photo_url }}" class="swal-photo-preview" alt="Face Preview">
                {% else %}
                <img id="swalPhotoPreview" src="{{ url_for('static', filename='images/default-profile.svg') }}" class="swal-photo-preview" alt="Face Preview">
                {% endif %}
                <div class="swal-photo-zone" onclick="document.getElementById('swalPhotoInput').click()">
                    <div style="font-weight:600;">Face Photo</div>
                    <div style="font-size:12px;color:#6b7280;">Click or drop to upload (JPG/PNG)</div>
                    <input id="swalPhotoInput" type="file" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this,'swalPhotoPreview')">
                </div>
                <div style="height:8px;"></div>
                <div class="swal-photo-zone" onclick="document.getElementById('swalIdFront').click()">
                    <div style="font-weight:600;">ID Front</div>
                    <div style="font-size:12px;color:#6b7280;">Click to upload</div>
                    <input id="swalIdFront" type="file" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this,'swalIdFrontPreview')">
                    <div id="swalIdFrontPreview" style="margin-top:8px; min-height:48px">{% if user.student_profile.id_front_path %}<img src="{{ url_for('static', filename=user.student_profile.id_front_path) }}" style="max-width:100%; height:auto; border-radius:6px;">{% endif %}</div>
                </div>
                <div style="height:8px;"></div>
                <div class="swal-photo-zone" onclick="document.getElementById('swalIdBack').click()">
                    <div style="font-weight:600;">ID Back</div>
                    <div style="font-size:12px;color:#6b7280;">Click to upload</div>
                    <input id="swalIdBack" type="file" accept="image/*" style="display:none;" onchange="previewProfilePhoto(this,'swalIdBackPreview')">
                    <div id="swalIdBackPreview" style="margin-top:8px; min-height:48px">{% if user.student_profile.id_back_path %}<img src="{{ url_for('static', filename=user.student_profile.id_back_path) }}" style="max-width:100%; height:auto; border-radius:6px;">{% endif %}</div>
                </div>
            </div>
            <div>
                <div class="swal-field"><label>First name</label><input id="swalFirstName" value="{{ user.personal_info.first_name or '' }}"></div>
                <div class="swal-field"><label>Last name</label><input id="swalLastName" value="{{ user.personal_info.last_name or '' }}"></div>
                <div class="swal-field"><label>Middle name</label><input id="swalMiddleName" value="{{ user.personal_info.middle_name or '' }}"></div>
                <div class="swal-field"><label>Email</label><input id="swalEmail" value="{{ user.personal_info.email or '' }}"></div>
                <div class="swal-field"><label>Phone</label><input id="swalPhone" value="{{ user.personal_info.phone or '' }}"></div>
                <div class="swal-field"><label>Address</label><input id="swalAddress" value="{{ user.personal_info.address or '' }}"></div>
                                <div class="swal-field-row">
                                    <div class="swal-field"><label>Birth date</label><input id="swalBirthDate" value="{{ user.personal_info.birth_date or '' }}" placeholder="YYYY-MM-DD"></div>
                                    <div class="swal-field"><label>Gender</label>
                    <select id="swalGender">
                      <option value="" {% if not user.personal_info.gender %}selected{% endif %}>Select</option>
                      <option value="Male" {% if user.personal_info.gender=='Male' %}selected{% endif %}>Male</option>
                      <option value="Female" {% if user.personal_info.gender=='Female' %}selected{% endif %}>Female</option>
                      <option value="Other" {% if user.personal_info.gender=='Other' %}selected{% endif %}>Other</option>
                    </select>
                  </div>
                </div>
                                <div class="swal-field-row" style="margin-top:6px;">
                                    <div class="swal-field"><label>Emergency name</label><input id="swalEmergName" value="{{ user.personal_info.emergency_contact_name or '' }}"></div>
                                    <div class="swal-field"><label>Emergency phone</label><input id="swalEmergPhone" value="{{ user.personal_info.emergency_contact_phone or '' }}"></div>
                </div>

                <hr style="margin:10px 0; border-color:#eef2f7;">

                <div class="swal-field"><label>School ID</label><input id="swalSchoolId" value="{{ user.school_id }}" disabled></div>
                <div class="swal-field"><label>Course</label>
                    <select id="swalCourse">
                        <option value="">Select Course</option>
                        <option value="BSIT" {% if user.student_profile.course=='BSIT' %}selected{% endif %}>BSIT</option>
                        <option value="BSCS" {% if user.student_profile.course=='BSCS' %}selected{% endif %}>BSCS</option>
                        <option value="BSIS" {% if user.student_profile.course=='BSIS' %}selected{% endif %}>BSIS</option>
                        <option value="BSCpE" {% if user.student_profile.course=='BSCpE' %}selected{% endif %}>BSCpE</option>
                        <option value="BSEMC" {% if user.student_profile.course=='BSEMC' %}selected{% endif %}>BSEMC</option>
                    </select>
                </div>
                                <div class="swal-field-row">
                                    <div class="swal-field"><label>Year Level</label><select id="swalYearLevel"><option value="">Select</option><option value="1" {% if user.student_profile.year_level==1 or user.student_profile.year_level=='1' %}selected{% endif %}>1</option><option value="2" {% if user.student_profile.year_level==2 or user.student_profile.year_level=='2' %}selected{% endif %}>2</option><option value="3" {% if user.student_profile.year_level==3 or user.student_profile.year_level=='3' %}selected{% endif %}>3</option><option value="4" {% if user.student_profile.year_level==4 or user.student_profile.year_level=='4' %}selected{% endif %}>4</option></select></div>
                                    <div class="swal-field"><label>Section</label><input id="swalSection" value="{{ user.student_profile.section or '' }}"></div>
                </div>
                <div class="swal-field"><label>Track</label><input id="swalTrack" value="{{ user.student_profile.track or '' }}"></div>
            </div>
        </div>
                </div>
    </template>

    <style>
        /* Global SweetAlert2 popup appearance for this page */
        .swal2-popup {
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(2,6,23,0.12);
        }

        /* Ensure the confirm/cancel buttons also respect rounded corners when shown as toasts */
        .swal2-toast .swal2-header, .swal2-toast .swal2-content {
            border-radius: 8px;
        }
        .class-item:hover {
            background-color: #f8fafc;
            border-color: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .collapsible-content {
            transition: all 0.3s ease;
        }

        .toggle-btn {
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background-color: #e5e7eb;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0, -10px, 0); }
            70% { transform: translate3d(0, -5px, 0); }
            90% { transform: translate3d(0, -2px, 0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #16a34a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
    </style>

    <script>
    // CSRF token for AJAX requests (Flask-WTF expects this header)
    const csrfToken = "{{ csrf_token() }}";

    let isClassListExpanded = false;
    let currentClassId = null;

        // Load joined classes when page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadJoinedClasses();

            // Welcome notification
            setTimeout(() => {
                Swal.fire({
                    title: 'üå± Welcome to Your Dashboard!',
                    text: 'Ready to join some classes? Enter a join code above.',
                    icon: 'info',
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end',
                    background: '#f0fdf4',
                    color: '#166534',
                    iconColor: '#16a34a'
                });
            }, 1000);
        });

        // Function to join a class
        function joinClass() {
            const joinCode = document.getElementById('joinCode').value.trim().toUpperCase();
            const joinButton = document.querySelector('.join-btn');

            if (!joinCode) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Missing Code',
                    text: 'Please enter a join code',
                    confirmButtonColor: '#16a34a'
                });
                return;
            }

            // Length validation now handled by backend first

            // Prevent multiple submissions
            if (joinButton.disabled) {
                return;
            }

            // Show loading
            const originalHTML = joinButton.innerHTML;
            joinButton.innerHTML = '<div class="spinner"></div>Joining...';
            joinButton.disabled = true;

            // Show loading toast
            let loadingSwal = Swal.fire({
                title: 'Joining Class...',
                text: 'Please wait while we enroll you',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/api/student/join-class', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ join_code: joinCode }),
                credentials: 'same-origin'  // Include cookies for authentication
            })
                .then(async response => {
                    console.log('Response status:', response.status);
                    console.log('Response type:', response.type);
                    console.log('Response url:', response.url);

                    // Handle redirects (authentication required)
                    if (response.status === 302 || response.redirected) {
                        console.log('Redirect detected - user not authenticated');
                        throw new Error('Authentication required. Please log in again.');
                    }

                    // Try to parse JSON body (server may return JSON even on 4xx)
                    let data = null;
                    try {
                        data = await response.json();
                    } catch (e) {
                        // Ignore parse errors; data remains null
                    }

                    if (!response.ok) {
                        // Handle common known server-side validation (e.g., already enrolled)
                        if (data && data.error && data.error.toLowerCase().includes('already enrolled')) {
                            console.log('Handling already enrolled response (4xx)');
                            // Close join loading toast
                            loadingSwal.close();

                            // Refresh classes immediately
                            loadJoinedClasses();

                            // Show friendly already-enrolled message
                            let message = 'You are already a member of this class.';
                            if (data && data.class_info) {
                                message += `\n\nClass: ${data.class_info.class_id}\nSchedule: ${data.class_info.schedule}`;
                            }

                            Swal.fire({
                                icon: 'success',
                                title: 'Already Enrolled!',
                                text: message,
                                timer: 3000,
                                timerProgressBar: true,
                                showConfirmButton: false,
                                toast: true,
                                position: 'top-end',
                                background: '#dcfce7',
                                color: '#166534'
                            });

                            // Resolve with a handled flag so the chain continues cleanly
                            return { handled: true };
                        }

                        // For other errors, prefer server-provided message if available
                        const errMsg = data && data.error ? data.error : `HTTP error! status: ${response.status}`;
                        throw new Error(errMsg);
                    }

                    return data;
                })
                .then(data => {
                    // If the earlier step returned a handled flag, do nothing further.
                    if (data && data.handled) {
                        console.log('Already-enrolled case handled; skipping further processing.');
                        return;
                    }

                    console.log('Response data:', data);
                    // Close loading toast
                    loadingSwal.close();

                    if (data && data.success) {
                        console.log('Join successful');
                        // Success notification
                        Swal.fire({
                            icon: 'success',
                            title: 'üéâ Success!',
                            text: data.message,
                            timer: 1500,
                            timerProgressBar: true,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end',
                            background: '#dcfce7',
                            color: '#166534'
                        });

                        // Clear the input and refresh classes list
                        document.getElementById('joinCode').value = '';

                        // Auto-refresh after successful join to ensure UI is updated
                        setTimeout(() => {
                            loadJoinedClasses();
                        }, 500);

                        // Add bounce animation to the button
                        joinButton.style.animation = 'bounce 0.6s ease';
                        setTimeout(() => {
                            joinButton.style.animation = '';
                        }, 600);
                    } else {
                        console.log('Join failed, error:', data && data.error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed to Join',
                            text: (data && data.error) || 'Unknown error occurred',
                            confirmButtonColor: '#16a34a'
                        });
                    }
                })
                .catch(error => {
                    // If we've already handled the 'already enrolled' case, don't show another error toast
                    if (error && error.message === 'handled_already_enrolled') {
                        return;
                    }

                    console.error('Network or parsing error:', error);

                    loadingSwal.close();

                    // Handle authentication errors
                    if (error.message && error.message.includes('Authentication required')) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Authentication Required',
                            text: 'Please log in again to continue.',
                            confirmButtonColor: '#16a34a',
                            confirmButtonText: 'Go to Login'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Connection Error',
                            text: error.message || 'Failed to join class. Please check your connection and try again.',
                            confirmButtonColor: '#16a34a'
                        });
                    }
                })
                .finally(() => {
                    console.log('Finally block executed');
                    joinButton.innerHTML = originalHTML;
                    joinButton.disabled = false;
                });
        }

        // Function to load joined classes
        function loadJoinedClasses() {
            const listDiv = document.getElementById('joinedClassesList');
            const countDiv = document.getElementById('classCount');
            listDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div>Loading your classes...</div>';

            fetch('/api/student/joined-classes', {
                credentials: 'same-origin'
            })
                .then(response => {
                    if (response.status === 302 || response.redirected) {
                        throw new Error('Authentication required. Please log in again.');
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.classes && data.classes.length > 0) {
                        // Update class count
                        countDiv.textContent = data.classes.length;

                        let html = '<div style="max-height: 200px; overflow-y: auto;">';
                        data.classes.forEach((cls, index) => {
                            html += `
                            <div class="class-item" style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; animation: slideInLeft 0.5s ease-out; animation-delay: ${index * 0.1}s; animation-fill-mode: both;"
                                 onclick="showClassDetails(${cls.id})">
                                <div style="font-weight: bold; color: #16a34a; margin-bottom: 5px;">üìö ${cls.class_id}</div>
                                <div style="font-size: 14px; color: #666;">
                                    ${cls.course} ${cls.track || ''} - ${cls.section}<br>
                                    üïí ${cls.schedule}
                                </div>
                            </div>
                        `;
                        });
                        html += '</div>';
                        listDiv.innerHTML = html;

                        // Show toggle button
                        document.getElementById('toggleClassesBtn').style.display = 'block';

                        // Success notification
                        Swal.fire({
                            icon: 'success',
                            title: 'Classes Loaded!',
                            text: `Found ${data.classes.length} class${data.classes.length > 1 ? 'es' : ''}`,
                            timer: 1500,
                            timerProgressBar: true,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end',
                            background: '#dcfce7',
                            color: '#166534'
                        });
                    } else {
                        countDiv.textContent = '0';
                        listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><div style="font-size: 48px; margin-bottom: 10px;">üì≠</div><p style="font-style: italic;">No classes joined yet.<br>Use the join code above to enroll in classes.</p></div>';
                        document.getElementById('toggleClassesBtn').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading classes:', error);
                    listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #dc3545;"><div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div><p>Failed to load classes. Please refresh the page.</p></div>';

                    Swal.fire({
                        icon: 'error',
                        title: 'Loading Error',
                        text: 'Failed to load your classes. Please refresh the page.',
                        confirmButtonColor: '#16a34a'
                    });
                });
        }

        // Function to toggle class list visibility
        function toggleClassList() {
            const listDiv = document.getElementById('joinedClassesList');
            const toggleBtn = document.getElementById('toggleClassesBtn');

            if (isClassListExpanded) {
                // Collapse
                listDiv.style.maxHeight = '200px';
                listDiv.style.overflow = 'hidden';
                toggleBtn.innerHTML = 'üìñ View All Classes';
                isClassListExpanded = false;
            } else {
                // Expand
                listDiv.style.maxHeight = 'none';
                listDiv.style.overflow = 'visible';
                toggleBtn.innerHTML = 'üìï Collapse Classes';
                isClassListExpanded = true;
            }
        }

        // Function to show class details in modal
        function showClassDetails(classId) {
            currentClassId = classId;

            fetch('/api/student/joined-classes', {
                credentials: 'same-origin'
            })
                .then(response => {
                    if (response.status === 302 || response.redirected) {
                        throw new Error('Authentication required. Please log in again.');
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const classData = data.classes.find(cls => cls.id === classId);
                    if (classData) {
                        const detailsDiv = document.getElementById('classDetails');
                        detailsDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <strong>Class ID:</strong> ${classData.class_id}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Course:</strong> ${classData.course}<br>
                            <strong>Track:</strong> ${classData.track || 'N/A'}<br>
                            <strong>Section:</strong> ${classData.section}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Year/Semester:</strong> ${classData.year} - ${classData.semester}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Schedule:</strong> ${classData.schedule}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Instructor:</strong> ${classData.instructor_name}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Class Code:</strong> ${classData.class_code}<br>
                            <strong>Join Code:</strong> ${classData.join_code}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Joined Date:</strong> ${new Date(classData.joined_at).toLocaleDateString()}
                        </div>
                    `;
                        document.getElementById('classModal').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading class details:', error);
                });
        }

        // Function to confirm leaving a class
        function confirmLeaveClass() {
            if (!currentClassId) return;

            Swal.fire({
                title: 'üö™ Leave Class?',
                html: 'Are you sure you want to leave this class? You will need to rejoin with a join code to access it again.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Leave Class',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d'
            }).then((result) => {
                if (result.isConfirmed) {
                    leaveClass();
                }
            });
        }

        // Function to leave a class
        function leaveClass() {
            if (!currentClassId) return;

            // Show loading
            const leaveButton = document.getElementById('leaveClassBtn');
            const originalHTML = leaveButton.innerHTML;
            leaveButton.innerHTML = '<div class="spinner"></div>Leaving...';
            leaveButton.disabled = true;

            fetch(`/api/student/leave-class/${currentClassId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Left Class!',
                            text: data.message,
                            timer: 2000,
                            showConfirmButton: false,
                            toast: true,
                            position: 'top-end',
                            background: '#dcfce7',
                            color: '#166534'
                        });

                        closeModal();
                        loadJoinedClasses(); // Refresh the classes list
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Failed to Leave',
                            text: data.error,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Connection Error',
                        text: 'Failed to leave class. Please check your connection.',
                        confirmButtonColor: '#dc3545'
                    });
                })
                .finally(() => {
                    leaveButton.innerHTML = originalHTML;
                    leaveButton.disabled = false;
                });
        }

        // Function to close modal
        function closeModal() {
            document.getElementById('classModal').style.display = 'none';
        }

        // Function to show messages
        function showMessage(message, type) {
            const messageDiv = document.getElementById('joinMessage');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            messageDiv.style.color = type === 'success' ? '#16a34a' : '#dc3545';
            messageDiv.style.fontWeight = 'bold';

            // Hide message after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Close modal when clicking outside
        document.getElementById('classModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // --- Edit profile modal and handlers ---
        // Assumption: backend endpoint for updating student profile is at /api/student/profile
        // and accepts PUT with multipart/form-data (photo optional). Adjust endpoint/method as needed.

        function previewProfilePhoto(input, targetId) {
            if (!input) return;
            const file = input.files && input.files[0];
            const tid = targetId || 'swalPhotoPreview';
            const preview = document.getElementById(tid);
            if (!file || !preview) return;

            // If preview is an <img>, set src; if it's a container div, inject an <img>
            const url = URL.createObjectURL(file);
            if (preview.tagName && preview.tagName.toLowerCase() === 'img') {
                preview.src = url;
                preview.onload = () => URL.revokeObjectURL(url);
            } else {
                preview.innerHTML = `<img src="${url}" style="max-width:100%; max-height:140px; object-fit:cover; border-radius:8px;">`;
                // revoke later when image loads
                const img = preview.querySelector('img');
                if (img) img.onload = () => URL.revokeObjectURL(url);
            }
        }

        function editProfile() {
            let modalResizeObserver = null;
            const html = document.getElementById('swal_edit_profile_template').innerHTML;

            Swal.fire({
                title: '‚úèÔ∏è Edit Profile',
                html: html,
                width: '760px',
                heightAuto: false,
                showCancelButton: true,
                focusConfirm: false,
                confirmButtonText: 'Update',
                cancelButtonText: 'Cancel',
                customClass: {
                    popup: 'swal-edit-profile',
                    htmlContainer: 'swal-edit-container',
                    actions: 'swal-edit-actions',
                    confirmButton: 'swal-edit-confirm',
                    cancelButton: 'swal-edit-cancel'
                },
                buttonsStyling: false,
                allowOutsideClick: true,
                allowEnterKey: true,
                allowEscapeKey: true,
                                
                preConfirm: () => {
                    const fd = new FormData();
                    fd.append('first_name', document.getElementById('swalFirstName').value.trim());
                    fd.append('last_name', document.getElementById('swalLastName').value.trim());
                    fd.append('middle_name', document.getElementById('swalMiddleName').value.trim());
                    fd.append('email', document.getElementById('swalEmail').value.trim());
                    fd.append('phone', document.getElementById('swalPhone').value.trim());
                    fd.append('address', document.getElementById('swalAddress').value.trim());
                    fd.append('birth_date', document.getElementById('swalBirthDate').value.trim());
                    fd.append('gender', document.getElementById('swalGender').value);
                    fd.append('emergency_contact_name', document.getElementById('swalEmergName').value.trim());
                    fd.append('emergency_contact_phone', document.getElementById('swalEmergPhone').value.trim());

                    fd.append('course', document.getElementById('swalCourse').value.trim());
                    fd.append('year_level', document.getElementById('swalYearLevel').value.trim());
                    fd.append('section', document.getElementById('swalSection').value.trim());
                    fd.append('track', document.getElementById('swalTrack').value.trim());

                    const faceInput = document.getElementById('swalPhotoInput');
                    const idFront = document.getElementById('swalIdFront');
                    const idBack = document.getElementById('swalIdBack');
                    const filesProvided = {};
                    if (faceInput && faceInput.files && faceInput.files.length > 0) { fd.append('face_photo', faceInput.files[0]); filesProvided.face_photo = faceInput.files[0]; }
                    if (idFront && idFront.files && idFront.files.length > 0) { fd.append('id_front', idFront.files[0]); filesProvided.id_front = idFront.files[0]; }
                    if (idBack && idBack.files && idBack.files.length > 0) { fd.append('id_back', idBack.files[0]); filesProvided.id_back = idBack.files[0]; }

                    if (!fd.get('first_name') || !fd.get('last_name')) {
                        Swal.showValidationMessage('First and last name are required');
                        return false;
                    }

                    return fetch('/api/student/profile', {
                        method: 'PUT',
                        headers: { 'X-CSRFToken': csrfToken },
                        body: fd,
                        credentials: 'same-origin'
                    }).then(async response => {
                        let data = null;
                        try { data = await response.json(); } catch (e) { }
                        if (!response.ok) {
                            const msg = data && data.error ? data.error : `HTTP ${response.status}`;
                            throw new Error(msg);
                        }
                        return { data: data, filesProvided: filesProvided };
                    }).catch(err => { throw new Error(err.message || 'Failed to update profile'); });
                }
            }).then((result) => {
                if (result && result.value && result.value.data) {
                    const res = result.value.data;
                    const prof = res.profile || res;
                    if (prof.course !== undefined) document.getElementById('courseSpan').textContent = prof.course;
                    if (prof.year_level !== undefined) document.getElementById('yearLevelSpan').textContent = prof.year_level;
                    if (prof.section !== undefined) document.getElementById('sectionSpan').textContent = prof.section;
                    if (prof.track !== undefined) document.getElementById('trackSpan').textContent = prof.track || 'No track set';

                    const profileImg = document.getElementById('profilePhoto');
                    if (prof.photo_url || prof.face_photo_url) {
                        profileImg.src = prof.photo_url || prof.face_photo_url;
                    } else if (result.value.filesProvided && result.value.filesProvided.face_photo) {
                        const localUrl = URL.createObjectURL(result.value.filesProvided.face_photo);
                        profileImg.src = localUrl;
                        profileImg.onload = () => URL.revokeObjectURL(localUrl);
                    }

                    Swal.fire({ icon: 'success', title: 'Profile Updated', text: (res.message) ? res.message : 'Your profile has been updated', timer: 1200, showConfirmButton: false, toast: true, position: 'top-end', background: '#dcfce7', color: '#166534' });
                    // Refresh the page after a short delay so all changes (including uploaded photos)
                    // are reflected from the server and any cached blobs are cleared.
                    setTimeout(() => { try { window.location.reload(); } catch (e) { console.warn('Reload failed', e); } }, 1400);
                }
            }).catch(err => {
                console.error('Update profile error:', err);
                Swal.fire({ icon: 'error', title: 'Update Failed', text: err.message || 'Failed to update profile', confirmButtonColor: '#dc3545' });
            }).finally(() => {
                if (modalResizeObserver) {
                    try { modalResizeObserver.disconnect(); modalResizeObserver = null; } catch (e) {}
                }
            });
            try {
                modalResizeObserver = new ResizeObserver(() => {
                    const popup = document.querySelector('.swal-edit-profile');
                    if (!popup) return;
                    const vh = window.innerHeight;
                    if (vh < 620) {
                        popup.style.top = Math.max(20, vh * 0.02 + 14) + 'px';
                        popup.style.height = Math.min(vh - 28, 0.92 * vh) + 'px';
                    } else {
                        popup.style.top = 'calc(3vh + 16px)';
                        popup.style.height = '';
                    }
                });
                modalResizeObserver.observe(document.body);
            } catch (e) {
                console.warn('ResizeObserver unavailable', e);
            }
        }

        // Allow Enter key to join class
        document.getElementById('joinCode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                joinClass();
            }
        });
    </script>
</body>

</html>
