<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Responsive Horizontal Class Record Accordion (Full View)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Ensure body covers the viewport for correct vh/vw calculations */
            min-height: 100vh;
            width: 100vw;
        }

        /* --- Custom CSS for Horizontal Accordion --- */

        .accordion-item {
            /* Set transition properties for smooth resizing of the column */
            /* faster, smoother transition and hint to browser to optimize */
            transition: width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            overflow: hidden;
            border-right: 1px solid #e5e7eb;
            /* Default width is set to a fixed pixel value for the header in JS */
            width: 64px;
            will-change: width;
        }

        /* Header in a horizontal accordion must have vertical text when collapsed */
        .accordion-header-inner {
            writing-mode: vertical-rl;
            /* Rotate text 90 degrees */
            transform: rotate(180deg);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column-reverse;
            /* Put icon below text in vertical mode */
            white-space: nowrap;
            /* Prevent wrapping of the header text */
            /* Ensure the text size scales responsively for the header button */
            font-size: 0.75rem;
            /* Base size */
        }

        @media (min-width: 640px) {
            .accordion-header-inner {
                font-size: 1rem;
                /* sm:text-base */
            }
        }

        @media (min-width: 1024px) {
            .accordion-header-inner {
                font-size: 1.25rem;
                /* lg:text-xl */
            }
        }

        /* Content area needs to be a standard flex column */
        .accordion-content-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
            /* Context for absolute Close button */
        }

        /* Initially hide content in the wrapper */
        .accordion-content {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            width: 0;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* --- HIDDEN SCROLLBAR STYLES (Applies to .accordion-content) --- */
        .accordion-content::-webkit-scrollbar {
            width: 0;
            height: 0;
            display: none;
        }

        .accordion-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --------------------------------- */

        /* Base expanded header style */
        .accordion-item.expanded .accordion-header {
            background-color: #3b82f6;
            color: white;
            padding: 0;
            height: 64px;
            width: 100%;
        }

        /* Expanded header styling: make text horizontal */
        .accordion-item.expanded .accordion-header-inner {
            writing-mode: horizontal-tb;
            transform: none;
            flex-direction: row;
            justify-content: flex-start;
            padding: 0 1rem;
            /* Responsive padding */
        }

        @media (min-width: 640px) {
            .accordion-item.expanded .accordion-header-inner {
                padding: 0 2rem;
            }
        }

        /* Specific header colors for distinction */
        #item-1.expanded .accordion-header {
            background-color: #16a34a;
        }

        /* Green */
        #item-2.expanded .accordion-header {
            background-color: #2563eb;
        }

        /* Blue */
        #item-3.expanded .accordion-header {
            background-color: #f97316;
        }

        /* Orange */
        #item-4.expanded .accordion-header {
            background-color: #dc2626;
        }

        /* Red */
        #item-5.expanded .accordion-header {
            background-color: #7c3aed;
        }

        /* Violet */

        .accordion-item.expanded .accordion-content {
            opacity: 1;
            width: auto;
            padding: 1rem;
            /* Responsive padding */
            overflow-x: auto;
        }

        @media (min-width: 640px) {
            .accordion-item.expanded .accordion-content {
                padding: 2rem;
            }
        }

        /* Styling for all input fields for a clean, modern look */
        .score-input {
            width: 50px;
            /* Smaller for mobile */
            padding: 0.25rem;
            border-radius: 0.25rem;
            border-width: 1px;
            font-size: 0.75rem;
            text-align: center;
        }

        @media (min-width: 640px) {
            .score-input {
                width: 60px;
                padding: 0.4rem;
                font-size: 0.8rem;
            }
        }

        .score-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Styling for read-only calculated totals */
        .total-output {
            border: none;
            box-shadow: none;
            background-color: #e5e7eb;
            font-weight: 700;
            width: 70px;
            /* Smaller for mobile */
        }

        @media (min-width: 640px) {
            .total-output {
                width: 80px;
            }
        }

        /* Ensure table borders are clearly defined */
        .score-table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }

        /* Table cell styling (responsive padding/font) */
        .score-table th,
        .score-table td {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.4rem 0.5rem;
            font-size: 0.75rem;
        }

        @media (min-width: 640px) {

            .score-table th,
            .score-table td {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                /* sm:text-sm */
            }
        }

        .score-table tbody tr:last-child td {
            border-bottom: none;
        }

        .score-table th:last-child,
        .score-table td:last-child {
            border-right: none;
        }

        /* Sticky student name column */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 5;
            background-color: white;
            box-shadow: 2px 0 2px -2px rgba(0, 0, 0, 0.1);
            width: 120px;
            /* Smaller base width for mobile */
        }

        @media (min-width: 640px) {
            .sticky-col {
                width: 150px;
            }
        }

        @media (min-width: 1024px) {
            .sticky-col {
                width: 192px;
                /* w-48 equivalent */
            }
        }
        /* Header action buttons (hidden until expanded) */
        .accordion-item .header-actions {
            display: none; /* toggled when expanded */
        }   

        .accordion-item.expanded .header-actions {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn {
            background: rgba(255,255,255,0.12);
            border: none;
            padding: 0.25rem;
            border-radius: 0.375rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .action-btn:hover { background: rgba(255,255,255,0.18); }

        /* Simple modal styles */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 50; }
        .modal-backdrop.show { display: flex; }
        .modal { background: white; border-radius: 0.5rem; padding: 1rem; width: 95%; max-width: 520px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal h3 { font-weight: 700; margin-bottom: 0.5rem; }
        .modal .modal-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .modal label { font-size: 0.875rem; font-weight: 600; }
        .modal input[type="text"], .modal input[type="number"] { padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; width: 100%; }
        .modal .modal-actions { display:flex; gap:0.5rem; justify-content:flex-end; margin-top:0.5rem; }

    /* Loading overlay used when lazily rendering large tables */
    .loading-overlay { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.7); z-index: 30; }
    .spinner { width: 36px; height: 36px; border-radius: 9999px; border: 4px solid rgba(0,0,0,0.08); border-top-color: rgba(0,0,0,0.6); animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen w-screen p-2 md:p-4">

    <!-- Main container using responsive screen units (80% on larger screens) -->
    <div id="main-container"
        class="w-[95%] h-[95vh] sm:w-[80vw] sm:h-[80vh] bg-white shadow-2xl rounded-xl flex flex-col overflow-hidden">

        <!-- Responsive Title -->
        <h1
            class="text-xl sm:text-2xl md:text-3xl font-extrabold p-3 sm:p-4 text-gray-800 bg-gray-50 border-b-2 border-indigo-100">
            1ST SEMESTER CLASS RECORD (50 Students)
        </h1>

        <div id="accordion-container" class="flex flex-row h-full w-full min-h-0">

            <!-- ACCORDION ITEM 1: LAB PARTICIPATION -->
            <div id="item-1" class="accordion-item bg-gray-100 rounded-tl-xl rounded-bl-xl">
                <div class="flex flex-col h-full w-full">
                    <button
                        class="accordion-header flex-shrink-0 h-full w-16 p-2 text-xl font-semibold text-gray-700 hover:bg-gray-200 transition-colors duration-300"
                        aria-expanded="false" data-target="content-1" data-category="lab-participation">
                        <div class="accordion-header-inner">
                            <span class="mb-2 sm:mb-4 text-green-700">LAB PARTICIPATION</span>
                                                        <div class="header-actions ml-2 hidden">
                                                                <span class="action-btn add-criteria-btn" role="button" tabindex="0" title="Add criteria" data-category="lab-participation">
                                                                        <!-- Plus icon -->
                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                </span>
                                                        </div>
                        </div>
                    </button>
                    <div id="content-1" class="accordion-content-wrapper bg-white h-full flex-grow">
                        <div class="accordion-content">
                            <!-- Responsive heading -->
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 text-green-800">1. Lab
                                Participation Scores (Max 10 per item)</h2>
                            <div id="table-lab-participation" class="overflow-y-auto max-h-full">
                                <!-- Table content dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCORDION ITEM 2: LAB HOMEWORK -->
            <div id="item-2" class="accordion-item bg-gray-100">
                <div class="flex flex-col h-full w-full">
                    <button
                        class="accordion-header flex-shrink-0 h-full w-16 p-2 text-xl font-semibold text-gray-700 hover:bg-gray-200 transition-colors duration-300"
                        aria-expanded="false" data-target="content-2" data-category="lab-homework">
                        <div class="accordion-header-inner">
                            <span class="mb-2 sm:mb-4 text-blue-700">LAB HOMEWORK</span>
                                                        <div class="header-actions ml-2 hidden">
                                                                <span class="action-btn add-criteria-btn" role="button" tabindex="0" title="Add criteria" data-category="lab-homework">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                </span>
                                                        </div>
                        </div>
                    </button>
                    <div id="content-2" class="accordion-content-wrapper bg-white h-full flex-grow">
                        <div class="accordion-content">
                            <!-- Responsive heading -->
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 text-blue-800">2. Lab
                                Homework Scores (Max 20 per item)</h2>
                            <div id="table-lab-homework" class="overflow-y-auto max-h-full">
                                <!-- Table content dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCORDION ITEM 3: LAB EXERCISE -->
            <div id="item-3" class="accordion-item bg-gray-100">
                <div class="flex flex-col h-full w-full">
                    <button
                        class="accordion-header flex-shrink-0 h-full w-16 p-2 text-xl font-semibold text-gray-700 hover:bg-gray-200 transition-colors duration-300"
                        aria-expanded="false" data-target="content-3" data-category="lab-exercise">
                        <div class="accordion-header-inner">
                            <span class="mb-2 sm:mb-4 text-orange-700">LAB EXERCISE</span>
                                                        <div class="header-actions ml-2 hidden">
                                                                <span class="action-btn add-criteria-btn" role="button" tabindex="0" title="Add criteria" data-category="lab-exercise">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                </span>
                                                        </div>
                        </div>
                    </button>
                    <div id="content-3" class="accordion-content-wrapper bg-white h-full flex-grow">
                        <div class="accordion-content">
                            <!-- Responsive heading -->
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 text-orange-800">3. Lab
                                Exercise Scores (Max 30 per item)</h2>
                            <div id="table-lab-exercise" class="overflow-y-auto max-h-full">
                                <!-- Table content dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCORDION ITEM 4: MIDTERM LAB EXAM -->
            <div id="item-4" class="accordion-item bg-gray-100">
                <div class="flex flex-col h-full w-full">
                    <button
                        class="accordion-header flex-shrink-0 h-full w-16 p-2 text-xl font-semibold text-gray-700 hover:bg-gray-200 transition-colors duration-300"
                        aria-expanded="false" data-target="content-4" data-category="midterm-lab-exam">
                        <div class="accordion-header-inner">
                            <span class="mb-2 sm:mb-4 text-red-700">MIDTERM LAB EXAM</span>
                                                        <div class="header-actions ml-2 hidden">
                                                                <span class="action-btn add-criteria-btn" role="button" tabindex="0" title="Add criteria" data-category="midterm-lab-exam">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                </span>
                                                        </div>
                        </div>
                    </button>
                    <div id="content-4" class="accordion-content-wrapper bg-white h-full flex-grow">
                        <div class="accordion-content">
                            <!-- Responsive heading -->
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 text-red-800">4. Midterm
                                Lab Exam (Max 100)</h2>
                            <div id="table-midterm-lab-exam" class="overflow-y-auto max-h-full">
                                <!-- Table content dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCORDION ITEM 5: FINAL LAB EXAM -->
            <div id="item-5" class="accordion-item bg-gray-100 rounded-tr-xl rounded-br-xl">
                <div class="flex flex-col h-full w-full">
                    <button
                        class="accordion-header flex-shrink-0 h-full w-16 p-2 text-xl font-semibold text-gray-700 hover:bg-gray-200 transition-colors duration-300"
                        aria-expanded="false" data-target="content-5" data-category="final-lab-exam">
                        <div class="accordion-header-inner">
                            <span class="mb-2 sm:mb-4 text-violet-700">FINAL LAB EXAM</span>
                                                        <div class="header-actions ml-2 hidden">
                                                                <span class="action-btn add-criteria-btn" role="button" tabindex="0" title="Add criteria" data-category="final-lab-exam">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                </span>
                                                        </div>
                        </div>
                    </button>
                    <div id="content-5" class="accordion-content-wrapper bg-white h-full flex-grow">
                        <div class="accordion-content">
                            <!-- Responsive heading -->
                            <h2 class="text-lg sm:text-xl md:text-2xl font-bold mb-3 sm:mb-4 text-violet-800">5. Final
                                Lab Exam (Max 150)</h2>
                            <div id="table-final-lab-exam" class="overflow-y-auto max-h-full">
                                <!-- Table content dynamically generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration for each category: number of inputs and max score per input
        const CATEGORY_CONFIG = {
            'lab-participation': { count: 5, maxScore: 10, name: 'LAB PARTICIPATION' },
            'lab-homework': { count: 3, maxScore: 20, name: 'LAB HOMEWORK' },
            'lab-exercise': { count: 3, maxScore: 30, name: 'LAB EXERCISE' },
            'midterm-lab-exam': { count: 1, maxScore: 100, name: 'MIDTERM LAB EXAM' },
            'final-lab-exam': { count: 1, maxScore: 150, name: 'FINAL LAB EXAM' },
        };

        // --- MOCK DATA GENERATION (50 STUDENTS) ---

        /**
         * Generates mock student data with random scores based on CATEGORY_CONFIG.
         * @param {number} count - The number of students to generate.
         * @returns {Array<Object>} The array of student data.
         */
        const generateStudentData = (count) => {
            const names = [
                "Reyes, Sofia L.", "Cruz, Juan M.", "Santos, Maria K.", "Garcia, Antonio B.",
                "Dela Cruz, Ben T.", "Lim, Chloe P.", "Tan, David R.", "Go, Emily S.",
                "Sy, Francis U.", "Chua, Hannah V."
            ];
            const surnames = ["Alvarez", "Bautista", "Castillo", "Diaz", "Estrada", "Fernandez", "Gomez", "Herrera", "Ibarra", "Javier"];

            const students = [];
            for (let i = 1; i <= count; i++) {
                const baseName = names[i % names.length];
                const lastName = surnames[i % surnames.length];
                // Create a unique name/ID combination
                const studentName = `${lastName}, ${baseName.split(', ')[1]} (ID: ${i.toString().padStart(2, '0')})`;

                // Function to generate a score array based on category config and a small random variance
                const generateScores = (categoryKey) => {
                    const { count, maxScore } = CATEGORY_CONFIG[categoryKey];
                    const scores = [];
                    // Base average score from 70% to 100% based on student ID to vary performance
                    const avgPercent = (70 + (i % 30));

                    for (let j = 0; j < count; j++) {
                        // Calculate score: (Max Score * Avg Percent) +/- variance
                        let score = maxScore * (avgPercent / 100);
                        score += (Math.random() - 0.5) * (maxScore * 0.1); // +/- 5% variance
                        score = Math.min(maxScore, Math.max(0, score)); // Clamp between 0 and Max
                        scores.push(Math.round(score * 10) / 10); // Round to one decimal place
                    }
                    return scores;
                };

                students.push({
                    id: i,
                    name: studentName,
                    scores: {
                        'lab-participation': generateScores('lab-participation'),
                        'lab-homework': generateScores('lab-homework'),
                        'lab-exercise': generateScores('lab-exercise'),
                        'midterm-lab-exam': generateScores('midterm-lab-exam'),
                        'final-lab-exam': generateScores('final-lab-exam')
                    }
                });
            }
            return students;
        };

        // Use 'let' because we may replace this with persisted data from localStorage
        let studentData = generateStudentData(50);

        /*
         * Persistence: save the current state (studentData + CATEGORY_CONFIG) to localStorage
         * so changes survive a page refresh for a configurable TTL (in minutes).
         *
         * To change the duration that saved changes persist, edit DEFAULT_TTL_MINUTES below.
         */
        const PERSIST_KEY = 'eclass_saved_state_v1';
        // Default TTL in minutes (customize this value as needed) --- change here to persist longer/shorter
        const DEFAULT_TTL_MINUTES = 15; // <-- change this value to control how long changes survive a refresh

        function _nowMs() { return Date.now(); }

        // Save state to localStorage. Optionally provide `expandedId` to remember which column is open.
        function saveState(ttlMinutes = DEFAULT_TTL_MINUTES, expandedId = null) {
            try {
                const payload = {
                    ts: _nowMs(),
                    ttlMinutes: ttlMinutes,
                    categoryConfig: CATEGORY_CONFIG,
                    studentData: studentData,
                    expandedId: expandedId
                };
                localStorage.setItem(PERSIST_KEY, JSON.stringify(payload));
            } catch (err) {
                // If storage quota exceeded or unavailable, fail silently
                console.warn('Could not save state to localStorage:', err);
            }
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(PERSIST_KEY);
                if (!raw) return null;
                const payload = JSON.parse(raw);
                if (!payload || !payload.ts) return null;
                const ageMinutes = (Date.now() - payload.ts) / 60000;
                const ttl = (typeof payload.ttlMinutes === 'number') ? payload.ttlMinutes : DEFAULT_TTL_MINUTES;
                if (ageMinutes > ttl) {
                    // expired
                    return null;
                }
                return payload;
            } catch (err) {
                console.warn('Could not load persisted state:', err);
                return null;
            }
        }

        // Load persisted state if present and not expired. Mutate CATEGORY_CONFIG and studentData in-place.
        (function restorePersistedState(){
            const persisted = loadState();
            if (!persisted) return;
            try {
                // Restore category config (mutate existing CONFIG object so references remain valid)
                Object.keys(persisted.categoryConfig || {}).forEach(k => {
                    if (CATEGORY_CONFIG[k]) {
                        // copy fields
                        Object.assign(CATEGORY_CONFIG[k], persisted.categoryConfig[k]);
                    } else {
                        // new category - assign entire object
                        CATEGORY_CONFIG[k] = persisted.categoryConfig[k];
                    }
                });

                // Restore student data
                if (Array.isArray(persisted.studentData)) {
                    studentData = persisted.studentData;
                }

                // Expose restored expanded id so DOMContentLoaded code can expand the same column.
                if (persisted.expandedId) {
                    // store globally for later use by the accordion initialization
                    window.__RESTORED_EXPANDED_ID = persisted.expandedId;
                }
            } catch (err) {
                console.warn('Failed to restore persisted state:', err);
            }
        })();

        // ------------------ Performance helpers ------------------
        // Debounced save so rapid typing doesn't thrash localStorage or cause FPS drops.
        let __saveTimer = null;
        function getExpandedId() {
            const el = document.querySelector('.accordion-item.expanded');
            return el ? el.id : null;
        }
        function scheduleSave(delay = 700) {
            // coalesce saves
            if (__saveTimer) clearTimeout(__saveTimer);
            __saveTimer = setTimeout(() => {
                try { saveState(DEFAULT_TTL_MINUTES, getExpandedId()); } catch (e) { /* ignore */ }
                __saveTimer = null;
            }, delay);
        }



        // --- DYNAMIC TABLE GENERATION & SCORING LOGIC ---

        /**
         * Renders the score table for a specific category into its content area.
         */
        function renderTable(categoryKey) {
            const { count, maxScore } = CATEGORY_CONFIG[categoryKey];
            const tableContainer = document.getElementById(`table-${categoryKey}`);

            // Start HTML string for the table
            let tableHTML = `
                <table class="w-full text-left score-table bg-white shadow-md">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="font-bold text-gray-700 sticky-col bg-gray-50">NAME OF STUDENTS</th>
            `;

            // Generate score column headers
            for (let i = 1; i <= count; i++) {
                tableHTML += `<th class="font-medium text-gray-600 text-center">Score ${i} <span class="text-xs font-normal">(Max ${maxScore})</span></th>`;
            }

            // Add Total column header
            tableHTML += `
                            <th class="font-extrabold text-white bg-gray-700 text-center">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Generate rows for each student
            studentData.forEach(student => {
                tableHTML += `<tr data-student-id="${student.id}" class="hover:bg-gray-100 transition-colors">
                                <td class="font-medium text-gray-800 sticky-col">${student.name}</td>`;

                // Generate input fields for scores in this category
                for (let i = 0; i < count; i++) {
                    const scoreValue = student.scores[categoryKey][i] !== undefined ? student.scores[categoryKey][i] : 0;
                    tableHTML += `<td>
                                    <input type="number" 
                                           class="score-input border-gray-300 data-input" 
                                           data-category="${categoryKey}"
                                           data-student-id="${student.id}"
                                           data-index="${i}"
                                           min="0"
                                           max="${maxScore}"
                                           value="${scoreValue}"
                                           placeholder="0"
                                    />
                                  </td>`;
                }

                // Add the Total Score output field
                tableHTML += `<td class="bg-gray-50 text-center">
                                <input type="text" 
                                       class="total-output text-center" 
                                       id="total-${categoryKey}-${student.id}" 
                                       value="0" 
                                       readonly
                                />
                              </td>
                            </tr>`;
            });

            tableHTML += `</tbody></table>`;

            // --- ADD CLOSE BUTTON HTML ---
            const closeButtonHTML = `
                <button id="close-btn-${categoryKey}" 
                        class="close-button absolute top-2 right-2 sm:top-4 sm:right-4 z-20 text-gray-400 hover:text-gray-700 p-2 rounded-full bg-white hover:bg-gray-100 transition-colors shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            `;

            // Place the button and table content
            tableContainer.innerHTML = tableHTML;

            // Find the correct content wrapper element by traversing the DOM from the table container.
            const contentDiv = tableContainer.closest('.accordion-content');
            const contentWrapper = contentDiv ? contentDiv.parentElement : null;

            // Add the close button to the content wrapper if it's not already there
            if (contentWrapper && !document.getElementById(`close-btn-${categoryKey}`)) {
                contentWrapper.insertAdjacentHTML('afterbegin', closeButtonHTML);
            }

            // Attach event listeners after content is rendered
            attachInputListeners(categoryKey);

            // Calculate totals for all rows initially
            studentData.forEach(student => calculateRowTotal(student.id, categoryKey));

            // Attach listener for the new close button
            const closeButton = document.getElementById(`close-btn-${categoryKey}`);
            if (closeButton) {
                closeButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevents outside-click logic from firing unnecessarily
                    const item = closeButton.closest('.accordion-item');
                    const header = item ? item.querySelector('.accordion-header') : null;
                    // collapsePanel is declared inside the DOMContentLoaded handler and isn't
                    // available here (renderTable is in the outer scope). Programmatically
                    // click the header so its click handler (which toggles expansion) runs.
                    if (header && typeof header.click === 'function') {
                        header.click();
                    } else if (item) {
                        // Fallback: remove expanded class and update aria if header isn't present
                        item.classList.remove('expanded');
                        const hdr = item.querySelector('.accordion-header');
                        if (hdr) hdr.setAttribute('aria-expanded', 'false');
                        // Reset widths for all items (best-effort fallback)
                        document.querySelectorAll('.accordion-item').forEach(i => i.style.width = '64px');
                    }
                });
            }
        }

        /**
         * Calculates and updates the total score for a single student in a given category.
         */
        function calculateRowTotal(studentId, categoryKey) {
            const student = studentData.find(s => s.id === studentId);
            if (!student) return;

            const scores = student.scores[categoryKey] || [];
            const total = scores.reduce((sum, score) => sum + parseFloat(score || 0), 0);

            const totalInput = document.getElementById(`total-${categoryKey}-${studentId}`);
            if (totalInput) {
                totalInput.value = total.toFixed(2);
            }
        }

        /**
         * Attaches 'input' listeners to all generated score fields in the current category.
         */
        function attachInputListeners(categoryKey) {
            // Use event delegation: attach a single input handler to the table container
            const container = document.getElementById(`table-${categoryKey}`);
            if (!container) return;
            if (container._inputWired) return; // avoid double-binding
            container._inputWired = true;

            container.addEventListener('input', (event) => {
                const target = event.target;
                if (!target || !target.classList || !target.classList.contains('data-input')) return;
                const studentId = parseInt(target.getAttribute('data-student-id'));
                const index = parseInt(target.getAttribute('data-index'));
                const max = parseFloat(target.getAttribute('max'));

                // 1. Update the underlying data model (fast, in-memory)
                let value = parseFloat(target.value);
                if (isNaN(value) || value < 0) value = 0;
                if (value > max) { value = max; target.value = max; }

                const student = studentData.find(s => s.id === studentId);
                if (student) {
                    student.scores[categoryKey][index] = value;
                }

                // 2. Recalculate and update the row total (DOM update for single cell)
                calculateRowTotal(studentId, categoryKey);

                // 3. Schedule a debounced save instead of saving on every keystroke
                scheduleSave();
            }, { passive: true });
        }


        // --- ACCORDION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('accordion-container');
            const items = container.querySelectorAll('.accordion-item');
            const mainContainer = document.getElementById('main-container');

            // If a restored expanded id was loaded from localStorage, keep it here until
            // after the expandPanel/collapsePanel functions are defined and we can call them.
            const restoredExpandedId = window.__RESTORED_EXPANDED_ID || null;

            // Define fixed width for the collapsed header in pixels (best for vertical text legibility)
            const COLLAPSED_WIDTH_PX = 64;
            let expandedItem = null;

            // Function to find the currently expanded item
            const getExpandedItem = () => document.querySelector('.accordion-item.expanded');
            // Helpers to show/hide a loading overlay inside an accordion-content-wrapper
            function showLoadingOverlay(targetId) {
                const wrapper = document.getElementById(targetId);
                if (!wrapper) return null;
                // If already has overlay, return it
                let overlay = wrapper.querySelector('.loading-overlay');
                if (overlay) { overlay.style.display = 'flex'; return overlay; }
                overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="spinner" aria-hidden="true"></div>';
                // Ensure wrapper is positioned (it already is) and insert overlay
                wrapper.insertAdjacentElement('beforeend', overlay);
                return overlay;
            }

            function hideLoadingOverlay(targetId) {
                const wrapper = document.getElementById(targetId);
                if (!wrapper) return;
                const overlay = wrapper.querySelector('.loading-overlay');
                if (overlay) overlay.style.display = 'none';
            }

            items.forEach(item => {
                const header = item.querySelector('.accordion-header');
                const categoryKey = header.getAttribute('data-category');

                // Do NOT pre-render all tables on load (lazy render when expanded)
                header.addEventListener('click', () => {
                    const isExpanded = item.classList.contains('expanded');

                    if (isExpanded) {
                        // Clicking an expanded header should close it
                        collapsePanel(item, header);
                    } else {
                        // Clicking a collapsed header should expand it
                        expandPanel(item, header);

                        // After expansion animation begins, lazily render the table if needed
                        if (categoryKey) {
                            const targetId = header.getAttribute('data-target');
                            const wrapper = document.getElementById(targetId);
                            const already = wrapper && wrapper.dataset && wrapper.dataset.rendered === 'true';
                            if (wrapper && !already) {
                                showLoadingOverlay(targetId);
                                // Give the browser a moment to paint the expanded panel, then render data.
                                setTimeout(() => {
                                    const doRender = () => {
                                        renderTable(categoryKey);
                                        // mark as rendered to avoid future re-renders
                                        const contentDiv = document.getElementById(`table-${categoryKey}`)?.closest('.accordion-content');
                                        const contentWrapper = contentDiv ? contentDiv.parentElement : null;
                                        if (contentWrapper) contentWrapper.dataset.rendered = 'true';
                                        hideLoadingOverlay(targetId);
                                    };
                                    if ('requestIdleCallback' in window) {
                                        requestIdleCallback(doRender, { timeout: 300 });
                                    } else {
                                        // fallback: small delay to avoid jank during animation
                                        setTimeout(doRender, 60);
                                    }
                                }, 40);
                            }
                        }
                    }
                });
            });

            /**
             * Collapses a specific accordion panel (column) and resets all items.
             */
            function collapsePanel(item, header) {
                if (!item.classList.contains('expanded')) return;

                item.classList.remove('expanded');
                header.setAttribute('aria-expanded', 'false');
                expandedItem = null;

                // Reset all items to their collapsed header width. Use rAF to coalesce layout changes.
                requestAnimationFrame(() => {
                    items.forEach(i => {
                        i.style.width = `${COLLAPSED_WIDTH_PX}px`;
                    });
                });
                // Persist the fact that no column is expanded
                try { saveState(DEFAULT_TTL_MINUTES, null); } catch (e) { /* ignore */ }
            }

            /**
             * Expands a specific accordion panel (column) to full width, hiding others.
             */
            function expandPanel(item, header) {
                // Collapse all other panels and hide them
                // Use rAF to batch DOM writes for smoother animations
                requestAnimationFrame(() => {
                    items.forEach(otherItem => {
                        const otherHeader = otherItem.querySelector('.accordion-header');
                        if (otherItem === item) {
                            // Expanded item takes the full width
                            otherItem.style.width = '100%';
                            otherItem.classList.add('expanded');
                            if (otherHeader) otherHeader.setAttribute('aria-expanded', 'true');
                            expandedItem = item;
                        } else {
                            // Other items become 0 width to disappear
                            otherItem.style.width = '0px';
                            otherItem.classList.remove('expanded');
                            if (otherHeader) otherHeader.setAttribute('aria-expanded', 'false');
                        }
                    });
                });
                // Persist which column is expanded so it can be restored after refresh
                try { saveState(DEFAULT_TTL_MINUTES, item.id); } catch (e) { /* ignore */ }
            }

            // --- Global Click Listener for Outside Click ---
            document.body.addEventListener('click', (event) => {
                const expanded = getExpandedItem();
                if (!expanded) return;

                // Check if the click occurred outside the main application container
                if (!mainContainer.contains(event.target)) {
                    const header = expanded.querySelector('.accordion-header');
                    collapsePanel(expanded, header);
                }
            });

            // Initial setup: ensure all panels are fully collapsed on load
            items.forEach(item => {
                const header = item.querySelector('.accordion-header');
                // Use a direct style manipulation here to prevent transition upon load
                item.style.width = `${COLLAPSED_WIDTH_PX}px`;
                header.setAttribute('aria-expanded', 'false');
            });

            // If a column was expanded in the persisted state, expand it now
            if (restoredExpandedId) {
                const el = document.getElementById(restoredExpandedId);
                if (el) {
                    const hdr = el.querySelector('.accordion-header');
                    if (hdr) {
                        expandPanel(el, hdr);
                    }
                }
            }
        });
    </script>

    <!-- Add Criteria Modal (reusable) -->
    <div id="addCriteriaModal" class="modal-backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addCriteriaTitle">
            <h3 id="addCriteriaTitle">Add Assessment / Criteria</h3>
            <div class="modal-row">
                <div style="flex:1">
                    <label for="criteria-name">Name</label>
                    <input id="criteria-name" type="text" placeholder="e.g. Score 6" />
                </div>
                <div style="width:140px">
                    <label for="criteria-max">Max Score</label>
                    <input id="criteria-max" type="number" min="1" value="10" />
                </div>
            </div>
            <div style="font-size:0.85rem;color:#6b7280;margin-bottom:0.5rem">The new score column will be appended to the right for all students in this category.</div>
            <div class="modal-actions">
                <button id="criteria-cancel" class="action-btn" type="button">Cancel</button>
                <button id="criteria-add" class="action-btn" type="button">Add</button>
            </div>
        </div>
    </div>

    <script>
        (function(){
            let currentModalCategory = null;
            const modal = document.getElementById('addCriteriaModal');
            const nameInput = document.getElementById('criteria-name');
            const maxInput = document.getElementById('criteria-max');
            const addBtn = document.getElementById('criteria-add');
            const cancelBtn = document.getElementById('criteria-cancel');

            function openAddCriteriaModal(categoryKey){
                currentModalCategory = categoryKey;
                const cfg = CATEGORY_CONFIG[categoryKey];
                if(!cfg) return;
                nameInput.value = `Score ${cfg.count + 1}`;
                maxInput.value = cfg.maxScore;
                modal.classList.add('show');
                modal.setAttribute('aria-hidden','false');
                // focus name input after a tick
                setTimeout(()=> nameInput.focus(), 50);
            }

            function closeAddCriteriaModal(){
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden','true');
                currentModalCategory = null;
            }

            // Adds the new criterion: updates config and student data and re-renders the table
            function submitAddCriteria(){
                if(!currentModalCategory) return closeAddCriteriaModal();
                const cat = currentModalCategory;
                const name = (nameInput.value || `Score ${CATEGORY_CONFIG[cat].count + 1}`).trim();
                let max = parseFloat(maxInput.value);
                if(isNaN(max) || max <= 0) max = CATEGORY_CONFIG[cat].maxScore;

                // Update config: increment count and set (uniform) maxScore for category
                CATEGORY_CONFIG[cat].count = (CATEGORY_CONFIG[cat].count || 0) + 1;
                CATEGORY_CONFIG[cat].maxScore = max;

                // Append a default score (0) for every student in that category
                studentData.forEach(s => {
                    if(!s.scores[cat]) s.scores[cat] = [];
                    s.scores[cat].push(0);
                });

                // Re-render the table for this category
                renderTable(cat);

                // Persist changes after adding a new criterion
                try { saveState(); } catch (e) { /* ignore if save not available */ }

                closeAddCriteriaModal();
            }

            // Wire modal buttons
            addBtn.addEventListener('click', (e)=>{ e.preventDefault(); submitAddCriteria(); });
            cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); closeAddCriteriaModal(); });

            // Clicking backdrop closes modal
            modal.addEventListener('click', (e)=>{ if(e.target === modal) closeAddCriteriaModal(); });

            // Attach listeners to header action buttons (stop propagation to avoid toggling)
            function wireHeaderActionButtons(){
                document.querySelectorAll('.add-criteria-btn').forEach(btn => {
                    // avoid double-binding
                    if(btn._wired) return;
                    btn._wired = true;
                    btn.addEventListener('click', (ev)=>{
                        ev.stopPropagation();
                        ev.preventDefault();
                        const cat = btn.getAttribute('data-category');
                        openAddCriteriaModal(cat);
                    });
                });
            }

            // Initial wiring now and also after DOM content load
            if(document.readyState === 'complete' || document.readyState === 'interactive'){
                wireHeaderActionButtons();
            } else {
                document.addEventListener('DOMContentLoaded', wireHeaderActionButtons);
            }

            // Also observe DOM mutations in case header buttons get re-rendered in the future
            const observer = new MutationObserver((mutations)=>{ wireHeaderActionButtons(); });
            observer.observe(document.body, { childList:true, subtree:true });
        })();
    </script>
</body>

</html> 