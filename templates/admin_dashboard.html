<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - E-Class Record</title>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-dashboard.css') }}">
</head>

<body>
    <div class="header">
        <div>
            <h1>‚ö° Admin Dashboard</h1>
            <p>Welcome, Admin {{ user.school_id }}!</p>
        </div>
        <div class="header-actions">
            <button onclick="createInstructor()" class="action-btn">üë®‚Äçüè´ Create Instructor</button>
            <a href="{{ url_for('auth.logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3>üë• User Management</h3>
            <p>Manage all users, students, and instructors.</p>
            <button onclick="createInstructor()" class="action-btn" style="margin-top: 15px;">üë®‚Äçüè´ Create
                Instructor</button>
           
        </div>

        <div class="card" id="instructorsCard">
            <h3>üë®‚Äçüè´ Added Instructors</h3>
            <div id="instructorsAnalytics">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="totalInstructors">0</div>
                        <div style="color: #6b7280;">Total Instructors</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #059669;" id="activeInstructors">0</div>
                        <div style="color: #6b7280;">Active</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; font-weight: bold; color: #dc2626;" id="suspendedInstructors">0</div>
                        <div style="color: #6b7280;">Suspended</div>
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #374151; font-size: 14px;">Recently Added</h4>
                    <div id="recentInstructors">
                        <p style="color: #6b7280; font-style: italic;">No instructors yet</p>
                    </div>
                </div>
                <button onclick="viewAllInstructors()" class="action-btn" style="width: 100%;">üëÅÔ∏è View All Instructors</button>
            </div>
        </div>


        <div class="card">
            <h3>üìä System Analytics</h3>
            <p>View instructor performance statistics and reports.</p>
            <p style="font-size: 12px; color: #6b7280; margin: 10px 0;">
                Access detailed analytics for each instructor from the Instructor Management section.
            </p>
        </div>

        <div class="card">
            <h3>üìö Class Overview</h3>
            <p>Analyze class distribution, enrollment, and grading structure completion.</p>
            <button onclick="openClassOverviewModal()" class="action-btn" style="margin-top: 15px;">üìà View Class Analytics</button>
        </div>

        <div class="card" id="gradeReleaseCard">
            <div class="card-header" onclick="toggleGradeReleaseDrawer()">
                <h3>üìä Grade Release Monitoring</h3>
                <span class="drawer-toggle" id="gradeReleaseToggle">‚ñº</span>
            </div>
            <p>Monitor final grade releases across all classes and instructors.</p>

            <!-- Summary Stats -->
            <div class="grade-release-summary" id="gradeReleaseSummary">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <div class="stat-mini-card">
                        <div class="stat-number" id="totalClassesCount">0</div>
                        <div class="stat-label">Total Classes</div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-number" id="releasedClassesCount">0</div>
                        <div class="stat-label">Grades Released</div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-number" id="pendingClassesCount">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-number" id="ungradedStudentsCount">0</div>
                        <div class="stat-label">Ungraded Students</div>
                    </div>
                </div>
            </div>

            <!-- Expandable Drawer Content -->
            <div class="drawer-content" id="gradeReleaseDrawer" style="display: none;">
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 107, 53, 0.2);">

                    <!-- Filters -->
                    <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <select id="gradeReleaseFilter" onchange="filterGradeReleaseClasses()" style="padding: 8px 12px; border: 1px solid rgba(255, 107, 53, 0.3); border-radius: 8px; font-size: 13px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);">
                            <option value="all">All Classes</option>
                            <option value="pending">Pending Release</option>
                            <option value="released">Grades Released</option>
                        </select>
                        <input type="text" id="gradeReleaseSearch" placeholder="Search by instructor or course..." oninput="filterGradeReleaseClasses()" style="padding: 8px 12px; border: 1px solid rgba(255, 107, 53, 0.3); border-radius: 8px; font-size: 13px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); flex: 1; min-width: 200px;">
                        <button onclick="refreshGradeReleaseData()" class="action-btn-small" style="padding: 8px 16px; font-size: 12px;">üîÑ Refresh</button>
                    </div>

                    <!-- Classes List -->
                    <div id="gradeReleaseClassesList" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <p>Loading grade release data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- CSRF Token for JavaScript -->
    <script>
        const csrfToken = "{{ csrf_token() }}";
    </script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <script>
        // Clean SweetAlert2 implementation - no random Swal calls
        function createInstructor() {
            Swal.fire({
                title: 'Create New Instructor',
                html: `
                    <div style="padding: 10px 0;">
                        <div style="display: flex; flex-direction: column; gap: 15px; max-height: 500px; overflow-y: auto;">

                            <!-- Personal Information Section -->
                            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">üìã Personal Information</h4>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">First Name *</label>
                                        <input type="text" id="firstName" placeholder="e.g. John" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Last Name *</label>
                                        <input type="text" id="lastName" placeholder="e.g. Doe" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Middle Name</label>
                                    <input type="text" id="middleName" placeholder="e.g. Smith" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Email *</label>
                                        <input type="email" id="email" placeholder="e.g. john.doe@university.edu" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Phone</label>
                                        <input type="tel" id="phone" placeholder="e.g. +63 912 345 6789" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Address</label>
                                    <input type="text" id="address" placeholder="Complete address" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Birth Date</label>
                                        <input type="date" id="birthDate" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Gender</label>
                                        <select id="gender" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box; background: white;">
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Emergency Contact</label>
                                        <input type="text" id="emergencyContactName" placeholder="Contact person name" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>

                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Contact Phone</label>
                                        <input type="tel" id="emergencyContactPhone" placeholder="Emergency contact number" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                    </div>
                                </div>
                            </div>

                            <!-- Account Information Section -->
                            <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <h4 style="margin: 0 0 15px 0; color: #92400e; font-size: 16px;">üîê Account Information</h4>

                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">School ID *</label>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <span style="background:#f3f4f6; padding:8px 10px; border:1px solid #d1d5db; border-radius:5px 0 0 5px; font-weight:600;">INS-</span>
                                        <input type="text" id="schoolIdSuffix" placeholder="001" maxlength="3" inputmode="numeric" pattern="\d{3}" style="flex:1; padding:10px; border:1px solid #d1d5db; border-radius:0 5px 5px 0; font-size:14px; box-sizing:border-box;">
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Employee ID</label>
                                    <div style="display:flex; align-items:center; gap:6px;">
                                        <span style="background:#f3f4f6; padding:8px 10px; border:1px solid #d1d5db; border-radius:5px 0 0 5px; font-weight:600;">INS-</span>
                                        <input type="text" id="employeeIdSuffix" placeholder="001" maxlength="3" inputmode="numeric" pattern="\d{3}" style="flex:1; padding:10px; border:1px solid #d1d5db; border-radius:0 5px 5px 0; font-size:14px; box-sizing:border-box;">
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Password *</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="password" id="password" placeholder="Enter password" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                        <button type="button" id="togglePassword" style="padding: 8px 10px; border: 1px solid #d1d5db; background: white; border-radius: 5px; cursor: pointer;">Show</button>
                                        <button type="button" id="generatePasswordBtn" style="padding:8px 10px; border:1px solid #d1d5db; background:#eef2ff; border-radius:5px; cursor:pointer;">Gen 6-digit</button>
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Confirm Password *</label>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <input type="password" id="confirmPassword" placeholder="Confirm password" style="flex: 1; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                        <button type="button" id="toggleConfirmPassword" style="padding: 8px 10px; border: 1px solid #d1d5db; background: white; border-radius: 5px; cursor: pointer;">Show</button>
                                    </div>
                                    <div id="passwordMatchMessage" style="margin-top:6px; font-size:13px; color: #6b7280;"></div>
                                </div>
                            </div>

                            <!-- Professional Information Section -->
                            <div style="background: #dbeafe; padding: 15px; border-radius: 8px;">
                                <h4 style="margin: 0 0 15px 0; color: #1e40af; font-size: 16px;">üéì Professional Information</h4>

                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department *</label>
                                    <select id="department" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box; background: white;">
                                        <option value="">Select Department</option>
                                        <option value="Computer Science">Computer Science</option>
                                        <option value="Information Technology">Information Technology</option>
                                        <option value="Mathematics">Mathematics</option>
                                        <option value="English">English</option>
                                        <option value="Science">Science</option>
                                        <option value="Business">Business</option>
                                        <option value="Engineering">Engineering</option>
                                    </select>
                                </div>

                                <div style="margin-top: 10px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Specialization</label>
                                    <input type="text" id="specialization" placeholder="e.g. Web Development" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 14px; box-sizing: border-box;">
                                </div>
                            </div>

                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Create Instructor',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#4F46E5',
                cancelButtonColor: '#6B7280',
                width: 450,
                padding: '20px',
                background: '#ffffff',
                didOpen: () => {
                    // Get elements (we use suffix inputs and prepend 'INS-' when submitting)
                    const pw = document.getElementById('password');
                    const cpw = document.getElementById('confirmPassword');
                    const firstName = document.getElementById('firstName');
                    const lastName = document.getElementById('lastName');
                    const email = document.getElementById('email');
                    const schoolIdSuffix = document.getElementById('schoolIdSuffix');
                    const employeeIdSuffix = document.getElementById('employeeIdSuffix');
                    const department = document.getElementById('department');
                    const togglePw = document.getElementById('togglePassword');
                    const toggleCpw = document.getElementById('toggleConfirmPassword');
                    const matchMsg = document.getElementById('passwordMatchMessage');
                    const confirmBtn = Swal.getConfirmButton();

                    // Helper to update match message and return whether password is valid
                    function updateMatchMessage() {
                        if (!pw || !cpw || !matchMsg) return false;
                        const p = pw.value || '';
                        const cp = cpw.value || '';

                        if (!p && !cp) {
                            matchMsg.textContent = '';
                            return false;
                        }

                        if (p !== cp) {
                            matchMsg.style.color = '#dc2626';
                            matchMsg.textContent = 'Passwords do not match';
                            return false;
                        }

                        // No length/complexity restrictions: only require that they match.
                        matchMsg.style.color = '#059669';
                        matchMsg.textContent = 'Passwords match';
                        console.debug('updateMatchMessage: passwords ok', { length: p.length });
                        return true;
                    }

                    // Validate important fields and password rules
                    function validateForm() {
                        const requiredFilled = firstName && lastName && email && schoolIdSuffix && department && pw
                            && firstName.value.trim() !== '' && lastName.value.trim() !== '' && email.value.trim() !== ''
                            && schoolIdSuffix.value.trim() !== '' && department.value.trim() !== '' && pw.value !== '';

                        // For UX: only require email to be present to enable the confirm button.
                        // Keep the stricter format check in `preConfirm` so users see validation messages on submit.
                        const emailOk = email && email.value.trim() !== '';

                        const pwOk = updateMatchMessage();

                        // Also ensure schoolIdSuffix is 3 digits
                        const schoolIdOk = /^\d{3}$/.test(schoolIdSuffix.value || '');

                        const valid = requiredFilled && emailOk && pwOk && schoolIdOk;

                        // Debug logging to trace why confirm stays disabled
                        console.debug('validateForm', {
                            firstName: firstName ? firstName.value : null,
                            lastName: lastName ? lastName.value : null,
                            email: email ? email.value : null,
                            schoolIdSuffix: schoolIdSuffix ? schoolIdSuffix.value : null,
                            employeeIdSuffix: employeeIdSuffix ? employeeIdSuffix.value : null,
                            department: department ? department.value : null,
                            pwSuffixPresent: pw ? (pw.value !== '') : null,
                            emailOk,
                            pwOk,
                            schoolIdOk,
                            requiredFilled,
                            valid
                        });

                        if (confirmBtn) {
                            confirmBtn.disabled = !valid;
                            confirmBtn.style.opacity = valid ? '1' : '0.6';
                            console.debug('confirmBtn set disabled =', confirmBtn.disabled);
                        } else {
                            console.warn('confirmBtn not found');
                        }
                    }

                    // Attach listeners
                    [pw, cpw].forEach(el => {
                        if (!el) return;
                        el.addEventListener('input', () => {
                            updateMatchMessage();
                            validateForm();
                        });
                    });

                    [firstName, lastName, email, schoolIdSuffix, department].forEach(el => {
                        if (!el) return;
                        el.addEventListener('input', validateForm);
                        el.addEventListener('change', validateForm);
                    });

                    // Toggle show/hide password
                    if (togglePw && pw) {
                        togglePw.addEventListener('click', () => {
                            pw.type = pw.type === 'password' ? 'text' : 'password';
                            togglePw.textContent = pw.type === 'password' ? 'Show' : 'Hide';
                        });
                    }
                    if (toggleCpw && cpw) {
                        toggleCpw.addEventListener('click', () => {
                            cpw.type = cpw.type === 'password' ? 'text' : 'password';
                            toggleCpw.textContent = cpw.type === 'password' ? 'Show' : 'Hide';
                        });
                    }

                    // Generate 6-digit code for password (fills both fields)
                    const genBtn = document.getElementById('generatePasswordBtn');
                    if (genBtn) {
                        genBtn.addEventListener('click', () => {
                            const code = Math.floor(100000 + Math.random() * 900000).toString();
                            if (pw) pw.value = code;
                            if (cpw) cpw.value = code;
                            updateMatchMessage();
                            validateForm();
                        });
                    }

                    // Initial validation state
                    setTimeout(validateForm, 50);
                },
                preConfirm: () => {
                    // Personal Information
                    const firstName = document.getElementById('firstName').value.trim();
                    const lastName = document.getElementById('lastName').value.trim();
                    const middleName = document.getElementById('middleName').value.trim();
                    const email = document.getElementById('email').value.trim();
                    const phone = document.getElementById('phone').value.trim();
                    const address = document.getElementById('address').value.trim();
                    const birthDate = document.getElementById('birthDate').value;
                    const gender = document.getElementById('gender').value;
                    const emergencyContactName = document.getElementById('emergencyContactName').value.trim();
                    const emergencyContactPhone = document.getElementById('emergencyContactPhone').value.trim();

                    // Account Information (combine suffix with fixed 'INS-' prefix for IDs only)
                    const schoolIdSuffix = document.getElementById('schoolIdSuffix').value.trim();
                    const schoolId = schoolIdSuffix ? ('INS-' + schoolIdSuffix) : '';
                    const password = document.getElementById('password').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const employeeIdSuffix = document.getElementById('employeeIdSuffix').value.trim();
                    const employeeId = employeeIdSuffix ? ('INS-' + employeeIdSuffix) : '';

                    // Professional Information
                    const department = document.getElementById('department').value;
                    const specialization = document.getElementById('specialization').value.trim();

                    // Validation
                    const errors = [];

                    // Required field validations
                    if (!firstName) errors.push('First name is required');
                    if (!lastName) errors.push('Last name is required');
                    if (!email) errors.push('Email is required');
                    if (!schoolId) errors.push('School ID is required');
                    if (!password) errors.push('Password is required');
                    if (!department) errors.push('Department is required');

                    // Password validation: only require passwords match; no complexity/length restriction
                    if (password !== confirmPassword) {
                        errors.push('Passwords do not match');
                    }

                    // Ensure the ID suffix follows 3 digits for INS-### format
                    if (!/^\d{3}$/.test(schoolIdSuffix)) {
                        errors.push('School ID must be in INS-### format');
                    }

                    // Email validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (email && !emailRegex.test(email)) {
                        errors.push('Please enter a valid email address');
                    }

                    // Phone validation (if provided)
                    if (phone && !/^[\+]?[0-9\s\-\(\)]{10,}$/.test(phone)) {
                        errors.push('Please enter a valid phone number');
                    }

                    if (errors.length > 0) {
                        Swal.showValidationMessage(errors.join('; '));
                        return false;
                    }

                    return {
                        // Personal Information
                        firstName,
                        lastName,
                        middleName,
                        email,
                        phone,
                        address,
                        birthDate,
                        gender,
                        emergencyContactName,
                        emergencyContactPhone,
                        // Account Information
                        schoolId,
                        password,
                        confirmPassword,
                        employeeId,
                        // Professional Information
                        department,
                        specialization
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;

                    // Show loading
                    Swal.fire({
                        title: 'Creating Instructor...',
                        text: 'Please wait...',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Send to server (with enhanced logging and robust response parsing)
                    console.log('Creating instructor payload:', data);

                    fetch('/admin/create-instructor', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // include both header variants in case the server expects one or the other
                            'X-CSRFToken': csrfToken,
                            'X-CSRF-Token': csrfToken,
                            // common header some frameworks check for AJAX
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(async response => {
                        console.log('Create-instructor response status:', response.status);
                        const text = await response.text();
                        // Try parse JSON, but handle non-JSON gracefully
                        try {
                            const json = text ? JSON.parse(text) : null;
                            return { ok: response.ok, status: response.status, json };
                        } catch (err) {
                            console.error('Non-JSON response from create-instructor:', text);
                            return { ok: response.ok, status: response.status, text };
                        }
                    })
                    .then(result => {
                        if (!result) return;

                        if (result.json) {
                            const resp = result.json;
                            console.log('Create-instructor JSON response:', resp);
                            if (resp.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: resp.message || 'Instructor created successfully!',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                // Immediately refresh the page so the new instructor appears
                                try { window.location.reload(); } catch (e) { console.warn('Reload failed', e); }
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error!',
                                    text: resp.message || resp.error || 'Failed to create instructor'
                                });
                            }
                            } else {
                            // Non-JSON response ‚Äî show text and log it
                            console.warn('Create-instructor returned non-JSON result:', result);
                            Swal.fire({
                                icon: result.ok ? 'success' : 'error',
                                title: result.ok ? 'Response Received' : 'Server Error',
                                text: result.text || ('Status: ' + result.status)
                            });
                            // If the server returned a non-JSON but successful response, refresh as well
                            if (result.ok) {
                                try { window.location.reload(); } catch (e) { console.warn('Reload failed', e); }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Network or parsing error creating instructor:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Network error occurred: ' + (error.message || error)
                        });
                    });
                }
            });
        }

        // Enhanced welcome message with animations
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'üî• Welcome, Admin!',
                    text: 'Your powerful admin dashboard is ready',
                    timer: 2500,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    position: 'top-end',
                    toast: true,
                    background: '#fef2f2',
                    color: '#991b1b',
                    iconColor: '#dc2626',
                    customClass: {
                        popup: 'animate__animated animate__fadeInRight'
                    }
                });
            }, 1000); // Delay to let page animations complete
        });

        // ==========================================
        // INSTRUCTOR MANAGEMENT SYSTEM
        // ==========================================

        let instructorsData = [];
        let currentInstructorId = null;
        let pendingAction = null;

        // Load instructor analytics on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadInstructorAnalytics();
        });

        function loadInstructorAnalytics() {
            console.log('Loading instructor analytics...');
            fetch('/api/admin/instructors')
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    if (data.success) {
                        displayInstructorAnalytics(data.analytics);
                        instructorsData = data.instructors;
                        displayInstructorsTable(data.instructors);
                    } else {
                        console.error('Failed to load instructor analytics:', data.error);
                        showNotification('Failed to load instructor data: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading instructor analytics:', error);
                    showNotification('Error loading instructor data: ' + error.message, 'error');
                });
        }

        function displayInstructorAnalytics(analytics) {
            document.getElementById('totalInstructors').textContent = analytics.total_instructors;
            document.getElementById('activeInstructors').textContent = analytics.active_instructors;
            document.getElementById('suspendedInstructors').textContent = analytics.suspended_instructors;

            const recentContainer = document.getElementById('recentInstructors');
            if (analytics.recent_instructors.length > 0) {
                recentContainer.innerHTML = analytics.recent_instructors.map(instructor => `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #e5e7eb;">
                        <span>${instructor.name}</span>
                        <span style="color: #6b7280; font-size: 12px;">${new Date(instructor.created_at).toLocaleDateString()}</span>
                    </div>
                `).join('');
            } else {
                recentContainer.innerHTML = '<p style="color: #6b7280; font-style: italic;">No instructors yet</p>';
            }
        }

        function viewAllInstructors() {
            document.getElementById('instructorsModal').style.display = 'block';
            if (instructorsData.length === 0) {
                loadInstructorAnalytics(); // Reload if no data
            }
        }

        function closeInstructorsModal() {
            document.getElementById('instructorsModal').style.display = 'none';
            // Reset filters
            document.getElementById('searchName').value = '';
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterStatus').value = '';
        }

        function displayInstructorsTable(instructors) {
            const tbody = document.getElementById('instructorsTableBody');

            if (instructors.length === 0) {
                document.getElementById('noInstructors').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            document.getElementById('noInstructors').style.display = 'none';

            tbody.innerHTML = instructors.map(instructor => `
                <tr>
                    <td>${instructor.id}</td>
                    <td>
                        <div>
                            <strong>${instructor.name}</strong><br>
                            <small style="color: #6b7280;">${instructor.school_id}</small>
                        </div>
                    </td>
                    <td>${instructor.department}</td>
                    <td>
                        <span class="status-badge status-${instructor.status}">
                            ${instructor.status}
                        </span>
                    </td>
                    <td>${instructor.created_at ? new Date(instructor.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td style="text-align: center;">
                        <button onclick="viewInstructorDetails(${instructor.id})" class="action-btn-small btn-view" title="View Details">üëÅÔ∏è</button>
                        <button onclick="viewInstructorStats(${instructor.id}, '${instructor.name}')" class="action-btn-small btn-stats" title="View Statistics">üìä</button>
                        ${instructor.status === 'active'
                            ? `<button onclick="confirmAction('suspend', ${instructor.id}, '${instructor.name}')" class="action-btn-small btn-suspend" title="Suspend">‚è∏Ô∏è</button>`
                            : `<button onclick="confirmAction('unsuspend', ${instructor.id}, '${instructor.name}')" class="action-btn-small btn-unsuspend" title="Unsuspend">‚ñ∂Ô∏è</button>`
                        }
                        <button onclick="confirmAction('delete', ${instructor.id}, '${instructor.name}')" class="action-btn-small btn-delete" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterInstructors() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterDepartment = document.getElementById('filterDepartment').value;
            const filterStatus = document.getElementById('filterStatus').value;

            const filteredInstructors = instructorsData.filter(instructor => {
                const matchesName = instructor.name.toLowerCase().includes(searchName);
                const matchesDepartment = !filterDepartment || instructor.department === filterDepartment;
                const matchesStatus = !filterStatus || instructor.status === filterStatus;

                return matchesName && matchesDepartment && matchesStatus;
            });

            displayInstructorsTable(filteredInstructors);
        }

        function sortTable(column) {
            // Simple sorting implementation
            instructorsData.sort((a, b) => {
                if (a[column] < b[column]) return -1;
                if (a[column] > b[column]) return 1;
                return 0;
            });
            displayInstructorsTable(instructorsData);
        }

        function viewInstructorDetails(instructorId) {
            closeInstructorsModal();
            currentInstructorId = instructorId;

            // Show loading state
            document.getElementById('instructorDetailsContent').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <p>Loading instructor details...</p>
                </div>
            `;

            document.getElementById('instructorDetailsModal').style.display = 'block';

            // Fetch instructor details
            fetch(`/api/admin/instructors/${instructorId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayInstructorDetails(data.instructor);
                    } else {
                        document.getElementById('instructorDetailsContent').innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #dc2626;">
                                <p>‚ùå Failed to load instructor details</p>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading instructor details:', error);
                    document.getElementById('instructorDetailsContent').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #dc2626;">
                            <p>‚ùå Error loading instructor details</p>
                        </div>
                    `;
                });
        }

        function displayInstructorDetails(instructor) {
            const content = document.getElementById('instructorDetailsContent');

            content.innerHTML = `
                <!-- Personal Information Section -->
                <div class="details-section">
                    <h4>üë§ Personal Information</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Full Name</div>
                            <div class="detail-value">${instructor.personal_info.first_name} ${instructor.personal_info.middle_name || ''} ${instructor.personal_info.last_name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value">${instructor.personal_info.email}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value">${instructor.personal_info.phone || 'Not provided'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Gender</div>
                            <div class="detail-value">${instructor.personal_info.gender || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Birth Date</div>
                            <div class="detail-value">${instructor.personal_info.birth_date ? new Date(instructor.personal_info.birth_date).toLocaleDateString() : 'Not provided'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${instructor.personal_info.address || 'Not provided'}</div>
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <h5 style="margin: 15px 0 10px 0; color: #6b7280;">Emergency Contact</h5>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Contact Name</div>
                            <div class="detail-value">${instructor.personal_info.emergency_contact_name || 'Not provided'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Contact Phone</div>
                            <div class="detail-value">${instructor.personal_info.emergency_contact_phone || 'Not provided'}</div>
                        </div>
                    </div>
                </div>

                <!-- Professional Information Section -->
                <div class="details-section">
                    <h4>üéì Professional Information</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">Department</div>
                            <div class="detail-value">${instructor.professional_info.department || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Specialization</div>
                            <div class="detail-value">${instructor.professional_info.specialization || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Employee ID</div>
                            <div class="detail-value">${instructor.professional_info.employee_id || 'Not specified'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Hire Date</div>
                            <div class="detail-value">${instructor.professional_info.hire_date ? new Date(instructor.professional_info.hire_date).toLocaleDateString() : 'Not specified'}</div>
                        </div>
                    </div>
                </div>

                <!-- Account Information Section -->
                <div class="details-section">
                    <h4>üîê Account Information</h4>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">School ID</div>
                            <div class="detail-value">${instructor.school_id}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">
                                <span class="status-badge status-${instructor.account_info.status}">
                                    ${instructor.account_info.status}
                                </span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Account Created</div>
                            <div class="detail-value">${new Date(instructor.account_info.created_at).toLocaleDateString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Last Updated</div>
                            <div class="detail-value">${instructor.account_info.updated_at ? new Date(instructor.account_info.updated_at).toLocaleDateString() : 'Never'}</div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div class="details-section">
                    <h4>üìä Statistics & Classes</h4>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-number">${instructor.statistics.total_classes}</div>
                            <div class="stat-label">Total Classes</div>
                        </div>
                    </div>

                    ${instructor.statistics.total_classes > 0 ? `
                        <div style="margin-top: 15px;">
                            <h5 style="margin: 0 0 10px 0; color: #6b7280;">Active Classes</h5>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${instructor.statistics.class_list.map(cls => `
                                    <div style="padding: 8px; background: white; margin-bottom: 5px; border-radius: 5px; border: 1px solid #e5e7eb;">
                                        <strong>${cls.class_id}</strong> - ${cls.course} ${cls.section}<br>
                                        <small style="color: #6b7280;">${cls.year} ${cls.semester} ‚Ä¢ Schedule: ${cls.schedule}</small>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : '<p style="color: #6b7280; font-style: italic;">No classes assigned yet</p>'}
                </div>

                <!-- Action Buttons -->
                <div style="text-align: right; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                    ${instructor.account_info.status === 'active'
                        ? `<button onclick="confirmAction('suspend', ${instructor.id}, '${instructor.personal_info.first_name} ${instructor.personal_info.last_name}')" class="action-btn-small btn-suspend">‚è∏Ô∏è Suspend Account</button>`
                        : `<button onclick="confirmAction('unsuspend', ${instructor.id}, '${instructor.personal_info.first_name} ${instructor.personal_info.last_name}')" class="action-btn-small btn-unsuspend">‚ñ∂Ô∏è Unsuspend Account</button>`
                    }
                    <button onclick="confirmAction('delete', ${instructor.id}, '${instructor.personal_info.first_name} ${instructor.personal_info.last_name}')" class="action-btn-small btn-delete">üóëÔ∏è Delete Account</button>
                </div>
            `;

            // Initialize filters after content is loaded
            setTimeout(() => {
                initializeFilters(data);
            }, 100);
        }

        function initializeFilters(data) {
            // Populate year filters
            const years = [...new Set([
                ...data.semester_stats.map(s => s.semester_key.split(' - ')[0]),
                ...data.assessment_stats.map(s => s.year),
                ...data.enrollment_stats.map(s => s.year),
                ...data.completion_stats.map(s => s.year)
            ])].sort().reverse();

            const yearFilters = ['semesterYearFilter', 'assessmentYearFilter', 'enrollmentYearFilter', 'completionYearFilter'];
            yearFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                }
            });

            // Populate semester filters
            const semesters = [...new Set([
                ...data.semester_stats.map(s => s.semester_key.split(' - ')[1]),
                ...data.assessment_stats.map(s => s.semester),
                ...data.enrollment_stats.map(s => s.semester),
                ...data.completion_stats.map(s => s.semester)
            ])].filter(s => s).sort();

            const semesterFilters = ['assessmentSemesterFilter', 'enrollmentSemesterFilter', 'completionSemesterFilter'];
            semesterFilters.forEach(filterId => {
                const select = document.getElementById(filterId);
                if (select) {
                    semesters.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester;
                        option.textContent = semester;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ==========================================
        // FILTERING FUNCTIONS
        // ==========================================

        function filterSemesterStats() {
            const yearFilter = document.getElementById('semesterYearFilter').value.toLowerCase();
            const rows = document.querySelectorAll('#semesterTableBody tr');

            rows.forEach(row => {
                const year = row.getAttribute('data-year').toLowerCase();
                const show = !yearFilter || year.includes(yearFilter);
                row.style.display = show ? '' : 'none';
            });
        }

        function resetSemesterFilter() {
            document.getElementById('semesterYearFilter').value = '';
            filterSemesterStats();
        }

        function filterDepartmentStats() {
            const searchTerm = document.getElementById('departmentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#departmentTableBody tr');

            rows.forEach(row => {
                const department = row.cells[0].textContent.toLowerCase();
                const show = !searchTerm || department.includes(searchTerm);
                row.style.display = show ? '' : 'none';
            });
        }

        function resetDepartmentFilter() {
            document.getElementById('departmentSearch').value = '';
            filterDepartmentStats();
        }

        function filterCourseStats() {
            const searchTerm = document.getElementById('courseSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#courseTableBody tr');

            rows.forEach(row => {
                const course = row.cells[0].textContent.toLowerCase();
                const show = !searchTerm || course.includes(searchTerm);
                row.style.display = show ? '' : 'none';
            });
        }

        function resetCourseFilter() {
            document.getElementById('courseSearch').value = '';
            filterCourseStats();
        }

        function filterAssessmentStats() {
            const yearFilter = document.getElementById('assessmentYearFilter').value;
            const semesterFilter = document.getElementById('assessmentSemesterFilter').value;
            const structureFilter = document.getElementById('assessmentStructureFilter').value;
            const rows = document.querySelectorAll('#assessmentTableBody tr');

            rows.forEach(row => {
                const year = row.getAttribute('data-year');
                const semester = row.getAttribute('data-semester');
                const structure = row.getAttribute('data-structure');

                const show = (!yearFilter || year === yearFilter) &&
                           (!semesterFilter || semester === semesterFilter) &&
                           (!structureFilter || structure === structureFilter);
                row.style.display = show ? '' : 'none';
            });
        }

        function resetAssessmentFilter() {
            document.getElementById('assessmentYearFilter').value = '';
            document.getElementById('assessmentSemesterFilter').value = '';
            document.getElementById('assessmentStructureFilter').value = '';
            filterAssessmentStats();
        }

        function filterEnrollmentStats() {
            const yearFilter = document.getElementById('enrollmentYearFilter').value;
            const semesterFilter = document.getElementById('enrollmentSemesterFilter').value;
            const rangeFilter = document.getElementById('enrollmentRangeFilter').value;
            const rows = document.querySelectorAll('#enrollmentTableBody tr');

            rows.forEach(row => {
                const year = row.getAttribute('data-year');
                const semester = row.getAttribute('data-semester');
                const enrolled = parseInt(row.getAttribute('data-enrolled'));

                let rangeMatch = true;
                if (rangeFilter) {
                    if (rangeFilter === '0-10') rangeMatch = enrolled <= 10;
                    else if (rangeFilter === '11-25') rangeMatch = enrolled >= 11 && enrolled <= 25;
                    else if (rangeFilter === '26-50') rangeMatch = enrolled >= 26 && enrolled <= 50;
                    else if (rangeFilter === '51+') rangeMatch = enrolled >= 51;
                }

                const show = (!yearFilter || year === yearFilter) &&
                           (!semesterFilter || semester === semesterFilter) &&
                           rangeMatch;
                row.style.display = show ? '' : 'none';
            });
        }

        function resetEnrollmentFilter() {
            document.getElementById('enrollmentYearFilter').value = '';
            document.getElementById('enrollmentSemesterFilter').value = '';
            document.getElementById('enrollmentRangeFilter').value = '';
            filterEnrollmentStats();
        }

        function filterCompletionStats() {
            const yearFilter = document.getElementById('completionYearFilter').value;
            const semesterFilter = document.getElementById('completionSemesterFilter').value;
            const statusFilter = document.getElementById('completionStatusFilter').value;
            const rangeFilter = document.getElementById('completionRangeFilter').value;
            const rows = document.querySelectorAll('#completionTableBody tr');

            rows.forEach(row => {
                const year = row.getAttribute('data-year');
                const semester = row.getAttribute('data-semester');
                const status = row.getAttribute('data-status');
                const percentage = parseInt(row.getAttribute('data-percentage'));

                let rangeMatch = true;
                if (rangeFilter) {
                    if (rangeFilter === '0-25') rangeMatch = percentage <= 25;
                    else if (rangeFilter === '26-50') rangeMatch = percentage >= 26 && percentage <= 50;
                    else if (rangeFilter === '51-75') rangeMatch = percentage >= 51 && percentage <= 75;
                    else if (rangeFilter === '76-99') rangeMatch = percentage >= 76 && percentage <= 99;
                    else if (rangeFilter === '100') rangeMatch = percentage === 100;
                }

                const show = (!yearFilter || year === yearFilter) &&
                           (!semesterFilter || semester === semesterFilter) &&
                           (!statusFilter || status === statusFilter) &&
                           rangeMatch;
                row.style.display = show ? '' : 'none';
            });
        }

        function resetCompletionFilter() {
            document.getElementById('completionYearFilter').value = '';
            document.getElementById('completionSemesterFilter').value = '';
            document.getElementById('completionStatusFilter').value = '';
            document.getElementById('completionRangeFilter').value = '';
            filterCompletionStats();
        }

        function closeInstructorDetailsModal() {
            document.getElementById('instructorDetailsModal').style.display = 'none';
            currentInstructorId = null;
        }

        function confirmAction(action, instructorId, instructorName) {
            currentInstructorId = instructorId;
            pendingAction = action;

            const actionMessages = {
                'suspend': {
                    title: '‚ö†Ô∏è Suspend Instructor',
                    message: `Are you sure you want to suspend "${instructorName}"? This will restrict their access to all system features.`,
                    buttonText: 'Suspend'
                },
                'unsuspend': {
                    title: '‚úÖ Unsuspend Instructor',
                    message: `Are you sure you want to unsuspend "${instructorName}"? This will restore their access to all system features.`,
                    buttonText: 'Unsuspend'
                },
                'delete': {
                    title: 'üóëÔ∏è Delete Instructor',
                    message: `Are you sure you want to permanently delete "${instructorName}"? This action cannot be undone and will remove all associated data.`,
                    buttonText: 'Delete'
                }
            };

            const config = actionMessages[action];
            document.getElementById('confirmationTitle').innerHTML = config.title;
            document.getElementById('confirmationMessage').textContent = config.message;
            document.getElementById('confirmActionBtn').textContent = config.buttonText;
            document.getElementById('confirmActionBtn').style.backgroundColor =
                action === 'delete' ? '#dc2626' : '#f59e0b';

            document.getElementById('confirmationModal').style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            currentInstructorId = null;
            pendingAction = null;
        }

        function executeConfirmedAction() {
            if (!currentInstructorId || !pendingAction) return;

            console.log(`Executing action: ${pendingAction} on instructor ${currentInstructorId}`);

            switch (pendingAction) {
                case 'suspend':
                case 'unsuspend':
                    updateInstructorStatus(currentInstructorId, pendingAction);
                    break;
                case 'delete':
                    deleteInstructor(currentInstructorId);
                    break;
            }

            closeConfirmationModal();
        }

        function updateInstructorStatus(instructorId, action) {
            const newStatus = action === 'suspend' ? 'suspended' : 'active';
            console.log(`Updating instructor ${instructorId} status to ${newStatus}`);

            fetch(`/api/admin/instructors/${instructorId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => {
                console.log('Update status response:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Update status data:', data);
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadInstructorAnalytics(); // Refresh data

                    // If details modal is open, refresh it
                    if (document.getElementById('instructorDetailsModal').style.display !== 'none') {
                        viewInstructorDetails(instructorId);
                    }
                } else {
                    showNotification(data.error || 'Failed to update instructor status', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating instructor status:', error);
                showNotification('Error updating instructor status: ' + error.message, 'error');
            });
        }

        function deleteInstructor(instructorId) {
            console.log(`Deleting instructor ${instructorId}`);

            fetch(`/api/admin/instructors/${instructorId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadInstructorAnalytics(); // Refresh data
                    closeInstructorDetailsModal(); // Close details modal if open
                } else {
                    showNotification(data.error || 'Failed to delete instructor', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting instructor:', error);
                showNotification('Error deleting instructor: ' + error.message, 'error');
            });
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 2000;
                animation: slideInRight 0.3s ease-out;
                ${type === 'success'
                    ? 'background: linear-gradient(135deg, #059669, #10b981);'
                    : 'background: linear-gradient(135deg, #dc2626, #ef4444);'
                }
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Remove notification after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const instructorsModal = document.getElementById('instructorsModal');
            const detailsModal = document.getElementById('instructorDetailsModal');
            const confirmationModal = document.getElementById('confirmationModal');
            const analyticsModal = document.getElementById('analyticsModal');
            const classOverviewModal = document.getElementById('classOverviewModal');

            if (event.target === instructorsModal) {
                closeInstructorsModal();
            }
            if (event.target === detailsModal) {
                closeInstructorDetailsModal();
            }
            if (event.target === confirmationModal) {
                closeConfirmationModal();
            }
            if (event.target === analyticsModal) {
                closeAnalyticsModal();
            }
            if (event.target === classOverviewModal) {
                closeClassOverviewModal();
            }
        }

    </script>

    <!-- Instructor Management Modals -->
    <!-- Instructor List Modal -->
    <div id="instructorsModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>üë®‚Äçüè´ Instructor Management</h3>
                <span class="close" onclick="closeInstructorsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Search and Filter Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Search by Name</label>
                            <input type="text" id="searchName" placeholder="Enter instructor name..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;" onkeyup="filterInstructors()">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Filter by Department</label>
                            <select id="filterDepartment" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;" onchange="filterInstructors()">
                                <option value="">All Departments</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="English">English</option>
                                <option value="Science">Science</option>
                                <option value="Business">Business</option>
                                <option value="Engineering">Engineering</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Filter by Status</label>
                            <select id="filterStatus" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;" onchange="filterInstructors()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Instructor Table -->
                <div style="overflow-x: auto;">
                    <table id="instructorsTable" style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="sortTable('id')">ID</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="sortTable('name')">Name</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="sortTable('department')">Department</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="sortTable('status')">Status</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="sortTable('created_at')">Date Added</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="instructorsTableBody">
                            <!-- Instructor data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading indicator -->
                <div id="instructorsLoading" style="text-align: center; padding: 20px; display: none;">
                    <p>Loading instructors...</p>
                </div>

                <!-- No data message -->
                <div id="noInstructors" style="text-align: center; padding: 40px; display: none;">
                    <p style="color: #6b7280;">No instructors found matching the current filters.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructor Details Modal -->
    <div id="instructorDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 id="detailsModalTitle">üë®‚Äçüè´ Instructor Details</h3>
                <span class="close" onclick="closeInstructorDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="instructorDetailsContent">
                <!-- Instructor details will be populated here -->
                <div style="text-align: center; padding: 20px;">
                    <p>Loading instructor details...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Actions -->
    <div id="confirmationModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 90%; max-width: 500px;">
            <div class="modal-header">
                <h3 id="confirmationTitle">‚ö†Ô∏è Confirm Action</h3>
                <span class="close" onclick="closeConfirmationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to perform this action?</p>
                <div style="margin-top: 20px; text-align: right;">
                    <button onclick="closeConfirmationModal()" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">Cancel</button>
                    <button id="confirmActionBtn" onclick="executeConfirmedAction()" style="background: #dc2626; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Confirm</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Students Modal -->
    <div id="studentsModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1200px;">
            <div class="modal-header">
                <h3>üë®‚Äçüéì Student Management</h3>
                <span class="close" onclick="closeStudentsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Filters -->
                <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <input type="text" id="searchStudentName" placeholder="Search by name..." oninput="filterStudents()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 5px; flex: 1; min-width: 200px;">
                    <select id="filterCourse" onchange="filterStudents()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;">
                        <option value="">All Courses</option>
                    </select>
                    <select id="filterYearLevel" onchange="filterStudents()" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 5px;">
                        <option value="">All Year Levels</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>

                <!-- Students Table -->
                <div style="overflow-x: auto;">
                    <table id="studentsTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th onclick="sortStudentsTable('id')" style="padding: 12px; text-align: left; cursor: pointer;">ID</th>
                                <th onclick="sortStudentsTable('name')" style="padding: 12px; text-align: left; cursor: pointer;">Name</th>
                                <th onclick="sortStudentsTable('course')" style="padding: 12px; text-align: left; cursor: pointer;">Course</th>
                                <th onclick="sortStudentsTable('year_level')" style="padding: 12px; text-align: left; cursor: pointer;">Year</th>
                                <th onclick="sortStudentsTable('section')" style="padding: 12px; text-align: left; cursor: pointer;">Section</th>
                                <th style="padding: 12px; text-align: left;">Created</th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <!-- Students will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading indicator -->
                <div id="studentsLoading" style="text-align: center; padding: 20px; display: none;">
                    <p>Loading students...</p>
                </div>

                <!-- No data message -->
                <div id="noStudents" style="text-align: center; padding: 40px; display: none;">
                    <p style="color: #6b7280;">No students found matching the current filters.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructor Analytics Modal -->
    <div id="analyticsModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="analyticsModalTitle">üìä Instructor Analytics</h3>
                <span class="close" onclick="closeAnalyticsModal()">&times;</span>
            </div>
            <div class="modal-body" id="analyticsContent">
                <!-- Analytics content will be populated here -->
                <div style="text-align: center; padding: 40px;">
                    <p>Loading instructor analytics...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Overview Modal -->
    <div id="classOverviewModal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1400px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>üìö Class Overview + Structure Analysis</h3>
                <span class="close" onclick="closeClassOverviewModal()">&times;</span>
            </div>
            <div class="modal-body" id="classOverviewContent">
                <!-- Class overview content will be populated here -->
                <div style="text-align: center; padding: 40px;">
                    <p>Loading class overview...</p>
                </div>
            </div>
        </div>
    </div>



    <script>
        // ==========================================
        // STUDENT MANAGEMENT SYSTEM
        // ==========================================

        let studentsData = [];

        function viewAllStudents() {
            document.getElementById('studentsModal').style.display = 'block';
            loadStudents();
        }

        function closeStudentsModal() {
            document.getElementById('studentsModal').style.display = 'none';
            document.getElementById('searchStudentName').value = '';
            document.getElementById('filterCourse').value = '';
            document.getElementById('filterYearLevel').value = '';
        }

        function loadStudents() {
            document.getElementById('studentsLoading').style.display = 'block';
            document.getElementById('noStudents').style.display = 'none';

            fetch('/api/admin/students')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('studentsLoading').style.display = 'none';
                    if (data.success) {
                        studentsData = data.students;
                        populateCourseFilter(data.students);
                        displayStudentsTable(data.students);
                    } else {
                        showNotification('Failed to load students: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    document.getElementById('studentsLoading').style.display = 'none';
                    showNotification('Error loading students: ' + error.message, 'error');
                });
        }

        function populateCourseFilter(students) {
            const courseFilter = document.getElementById('filterCourse');
            const courses = [...new Set(students.map(s => s.course).filter(c => c))];
            courseFilter.innerHTML = '<option value="">All Courses</option>' +
                courses.map(course => `<option value="${course}">${course}</option>`).join('');
        }

        function displayStudentsTable(students) {
            const tbody = document.getElementById('studentsTableBody');

            if (students.length === 0) {
                document.getElementById('noStudents').style.display = 'block';
                tbody.innerHTML = '';
                return;
            }

            document.getElementById('noStudents').style.display = 'none';

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>
                        <div>
                            <strong>${student.name}</strong><br>
                            <small style="color: #6b7280;">${student.school_id}</small>
                        </div>
                    </td>
                    <td>${student.course}</td>
                    <td>${student.year_level} Year</td>
                    <td>${student.section}</td>
                    <td>${student.created_at ? new Date(student.created_at).toLocaleDateString() : 'N/A'}</td>
                    <td style="text-align: center;">
                        <button onclick="viewStudentDetails(${student.id})" class="action-btn-small btn-view" title="View Details">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterStudents() {
            const searchName = document.getElementById('searchStudentName').value.toLowerCase();
            const filterCourse = document.getElementById('filterCourse').value;
            const filterYearLevel = document.getElementById('filterYearLevel').value;

            const filteredStudents = studentsData.filter(student => {
                const matchesName = student.name.toLowerCase().includes(searchName);
                const matchesCourse = !filterCourse || student.course === filterCourse;
                const matchesYearLevel = !filterYearLevel || student.year_level.toString() === filterYearLevel;

                return matchesName && matchesCourse && matchesYearLevel;
            });

            displayStudentsTable(filteredStudents);
        }

        function sortStudentsTable(column) {
            studentsData.sort((a, b) => {
                if (a[column] < b[column]) return -1;
                if (a[column] > b[column]) return 1;
                return 0;
            });
            displayStudentsTable(studentsData);
        }

        function viewStudentDetails(studentId) {
            closeStudentsModal();
            // Implementation for viewing student details
            showNotification('Student details view coming soon', 'info');
        }



        // Utility function for notifications
        function showNotification(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            Swal.fire({
                icon: type,
                title: message,
                timer: 3000,
                timerProgressBar: true,
                showConfirmButton: false,
                position: 'top-end',
                toast: true,
                background: '#fef2f2',
                color: colors[type] || colors.info
            });
        }

        // ==========================================
        // INSTRUCTOR ANALYTICS SYSTEM
        // ==========================================

        function viewInstructorStats(instructorId, instructorName) {
            document.getElementById('analyticsModal').style.display = 'block';
            document.getElementById('analyticsModalTitle').textContent = `üìä Statistics for ${instructorName}`;
            loadInstructorStats(instructorId);
        }

        function loadInstructorStats(instructorId) {
            document.getElementById('analyticsContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p>Loading instructor analytics...</p>
                </div>
            `;

            console.log('Loading stats for instructor:', instructorId);

            // Fetch both analytics and classes data
            Promise.all([
                fetch(`/api/admin/system-analytics?instructor_id=${instructorId}`)
                    .then(r => {
                        console.log('Analytics response status:', r.status);
                        if (!r.ok) {
                            // Return empty analytics on error instead of throwing
                            return { success: false, analytics: [] };
                        }
                        return r.json();
                    })
                    .catch(err => {
                        console.warn('Analytics fetch failed:', err);
                        return { success: false, analytics: [] };
                    }),
                fetch(`/api/admin/instructors/${instructorId}/classes`)
                    .then(r => {
                        console.log('Classes response status:', r.status);
                        if (!r.ok) {
                            throw new Error(`Classes request failed with status ${r.status}`);
                        }
                        return r.json();
                    })
            ])
                .then(([analyticsData, classesData]) => {
                    console.log('Analytics data received:', analyticsData);
                    console.log('Classes data received:', classesData);
                    
                    if (analyticsData.success && analyticsData.analytics.length > 0) {
                        const classes = classesData.success ? (classesData.classes || []) : [];
                        displayInstructorStatsDetails(analyticsData.analytics[0], classes);
                    } else if (classesData.success) {
                        // Show classes even if analytics failed
                        const defaultAnalytics = {
                            instructor_id: instructorId,
                            instructor_name: 'Instructor',
                            department: 'N/A',
                            total_classes: classesData.classes.length,
                            total_snapshots: 0,
                            total_releases: 0,
                            avg_students_per_class: 0
                        };
                        displayInstructorStatsDetails(defaultAnalytics, classesData.classes || []);
                    } else {
                        document.getElementById('analyticsContent').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc2626;">
                                <p>‚ùå Failed to load data</p>
                                <p>${analyticsData.error || classesData.error || 'No data available for this instructor'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    document.getElementById('analyticsContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <p>‚ùå Error loading analytics</p>
                            <p style="font-size: 14px; color: #6b7280;">${error.message}</p>
                        </div>
                    `;
                });
        }

        function displayInstructorStatsDetails(instructor, classes) {
            const content = document.getElementById('analyticsContent');

            content.innerHTML = `
                <div style="margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${instructor.total_classes}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Total Classes</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${instructor.total_snapshots}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Grade Snapshots</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${instructor.total_releases}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Grade Releases</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${instructor.avg_students_per_class}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Avg Students/Class</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìä Performance Overview</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #374151;">Instructor Details</h5>
                            <p style="margin: 5px 0; color: #6b7280;"><strong>Name:</strong> ${instructor.instructor_name}</p>
                            <p style="margin: 5px 0; color: #6b7280;"><strong>Department:</strong> ${instructor.department}</p>
                        </div>
                        <div>
                            <h5 style="margin: 0 0 10px 0; color: #374151;">Activity Summary</h5>
                            <p style="margin: 5px 0; color: #6b7280;"><strong>Snapshots per Class:</strong> ${(instructor.total_classes > 0 ? (instructor.total_snapshots / instructor.total_classes).toFixed(1) : 0)}</p>
                            <p style="margin: 5px 0; color: #6b7280;"><strong>Releases per Class:</strong> ${(instructor.total_classes > 0 ? (instructor.total_releases / instructor.total_classes).toFixed(1) : 0)}</p>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìà Detailed Metrics</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Metric</th>
                                    <th style="padding: 12px; text-align: center;">Value</th>
                                    <th style="padding: 12px; text-align: left;">Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 12px; font-weight: 600; color: #1f2937;">Total Classes</td>
                                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea;">${instructor.total_classes}</td>
                                    <td style="padding: 12px; color: #6b7280;">Number of classes assigned to this instructor</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 12px; font-weight: 600; color: #1f2937;">Grade Snapshots</td>
                                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #f5576c;">${instructor.total_snapshots}</td>
                                    <td style="padding: 12px; color: #6b7280;">Number of finalized grade snapshots created</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 12px; font-weight: 600; color: #1f2937;">Grade Releases</td>
                                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #00f2fe;">${instructor.total_releases}</td>
                                    <td style="padding: 12px; color: #6b7280;">Number of times grades have been released to students</td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; font-weight: 600; color: #1f2937;">Average Students per Class</td>
                                    <td style="padding: 12px; text-align: center; font-weight: bold; color: #38f9d7;">${instructor.avg_students_per_class}</td>
                                    <td style="padding: 12px; color: #6b7280;">Average number of students across all classes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Classes and Students Card -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìö Classes & Students</h4>
                    ${classes.length > 0 ? classes.map(cls => `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                                <div style="flex: 1;">
                                    <h5 style="margin: 0 0 5px 0; color: #1f2937; font-size: 16px;">
                                        ${cls.class_display_id}
                                    </h5>
                                    <p style="margin: 2px 0; color: #6b7280; font-size: 13px;">
                                        <strong>Subject:</strong> ${cls.subject || 'N/A'} | 
                                        <strong>Schedule:</strong> ${cls.schedule || 'N/A'}
                                    </p>
                                    <p style="margin: 2px 0; color: #6b7280; font-size: 13px;">
                                        <strong>Class Code:</strong> ${cls.class_code || 'N/A'} | 
                                        <strong>Join Code:</strong> ${cls.join_code || 'N/A'}
                                    </p>
                                </div>
                                <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 8px; min-width: 80px;">
                                    <div style="font-size: 24px; font-weight: bold;">${cls.student_count}</div>
                                    <div style="font-size: 11px; opacity: 0.9;">Students</div>
                                </div>
                            </div>
                            
                            ${cls.students.length > 0 ? `
                                <div style="margin-top: 10px;">
                                    <h6 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">Enrolled Students:</h6>
                                    <div style="max-height: 250px; overflow-y: auto; background: white; border-radius: 6px; padding: 8px;">
                                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                            <thead>
                                                <tr style="background: #f3f4f6; border-bottom: 1px solid #e5e7eb;">
                                                    <th style="padding: 8px; text-align: left; font-weight: 600;">School ID</th>
                                                    <th style="padding: 8px; text-align: left; font-weight: 600;">Name</th>
                                                    <th style="padding: 8px; text-align: left; font-weight: 600;">Course</th>
                                                    <th style="padding: 8px; text-align: center; font-weight: 600;">Year</th>
                                                    <th style="padding: 8px; text-align: left; font-weight: 600;">Section</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${cls.students.map((student, idx) => `
                                                    <tr style="border-bottom: 1px solid #f3f4f6; ${idx % 2 === 0 ? 'background: #fafafa;' : ''}">
                                                        <td style="padding: 8px; color: #4b5563;">${student.school_id}</td>
                                                        <td style="padding: 8px; color: #1f2937; font-weight: 500;">${student.name}</td>
                                                        <td style="padding: 8px; color: #6b7280;">${student.course || 'N/A'}</td>
                                                        <td style="padding: 8px; text-align: center; color: #6b7280;">${student.year_level || 'N/A'}</td>
                                                        <td style="padding: 8px; color: #6b7280;">${student.section || 'N/A'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : `
                                <p style="margin: 10px 0 0 0; color: #9ca3af; font-style: italic; font-size: 13px; text-align: center;">No students enrolled yet</p>
                            `}
                        </div>
                    `).join('') : `
                        <div style="text-align: center; padding: 40px; color: #9ca3af;">
                            <p style="font-size: 16px;">üì≠ No classes assigned to this instructor yet</p>
                        </div>
                    `}
                </div>
            `;
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').style.display = 'none';
        }

        // ==========================================
        // GRADE RELEASE MONITORING SYSTEM
        // ==========================================

        let gradeReleaseData = [];
        let filteredGradeReleaseData = [];

        // Load grade release data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadGradeReleaseData();
        });

        function toggleGradeReleaseDrawer() {
            const drawer = document.getElementById('gradeReleaseDrawer');
            const toggle = document.getElementById('gradeReleaseToggle');

            if (drawer.style.display === 'none' || drawer.style.display === '') {
                drawer.style.display = 'block';
                toggle.textContent = '‚ñ≤';
                toggle.style.transform = 'rotate(180deg)';
            } else {
                drawer.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function loadGradeReleaseData() {
            console.log('Loading grade release data...');

            fetch('/api/admin/grade-release-monitoring')
                .then(response => response.json())
                .then(data => {
                    console.log('Grade release data received:', data);
                    if (data.success) {
                        gradeReleaseData = data.classes;
                        filteredGradeReleaseData = [...gradeReleaseData];
                        displayGradeReleaseSummary(data.summary);
                        displayGradeReleaseClasses(filteredGradeReleaseData);
                    } else {
                        console.error('Failed to load grade release data:', data.error);
                        showNotification('Failed to load grade release data: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading grade release data:', error);
                    showNotification('Error loading grade release data: ' + error.message, 'error');
                });
        }

        function displayGradeReleaseSummary(summary) {
            document.getElementById('totalClassesCount').textContent = summary.total_classes;
            document.getElementById('releasedClassesCount').textContent = summary.released_classes;
            document.getElementById('pendingClassesCount').textContent = summary.pending_classes;
            document.getElementById('ungradedStudentsCount').textContent = summary.ungraded_students;
        }

        function displayGradeReleaseClasses(classes) {
            const container = document.getElementById('gradeReleaseClassesList');

            if (classes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <p>No classes found matching the current filters.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = classes.map(cls => `
                <div class="grade-release-class-item ${cls.grade_released ? 'released' : 'pending'}">
                    <div class="class-header">
                        <div class="class-info">
                            <h4>${cls.class_display_id || `${cls.course} ${cls.section}`}</h4>
                            <div class="class-meta">Instructor: ${cls.instructor_name}</div>
                            <div class="class-meta">Department: ${cls.department}</div>
                            <div class="class-meta">Schedule: ${cls.schedule || 'N/A'}</div>
                        </div>
                        <div class="class-stats">
                            <div class="stat-item">
                                <span class="stat-value">${cls.total_students}</span>
                                <span class="stat-label">Students</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${cls.graded_students}</span>
                                <span class="stat-label">Graded</span>
                            </div>
                            <div class="release-status ${cls.grade_released ? 'released' : 'pending'}">
                                ${cls.grade_released ? 'Released' : 'Pending'}
                            </div>
                        </div>
                    </div>
                    ${!cls.grade_released ? `
                        <div style="margin-top: 12px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; border-left: 3px solid #f59e0b;">
                            <small style="color: #92400e; font-weight: 600;">
                                ‚è∞ ${cls.ungraded_students} students still ungraded
                                ${cls.oldest_pending ? ` ‚Ä¢ Oldest pending: ${new Date(cls.oldest_pending).toLocaleDateString()}` : ''}
                            </small>
                        </div>
                    ` : `
                        <div style="margin-top: 12px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
                            <small style="color: #065f46; font-weight: 600;">
                                ‚úÖ Grades released on ${new Date(cls.release_date).toLocaleDateString()}
                            </small>
                        </div>
                    `}
                </div>
            `).join('');
        }

        function filterGradeReleaseClasses() {
            const filterValue = document.getElementById('gradeReleaseFilter').value;
            const searchValue = document.getElementById('gradeReleaseSearch').value.toLowerCase();

            filteredGradeReleaseData = gradeReleaseData.filter(cls => {
                // Filter by status
                const statusMatch = filterValue === 'all' ||
                    (filterValue === 'released' && cls.grade_released) ||
                    (filterValue === 'pending' && !cls.grade_released);

                // Filter by search
                const searchMatch = !searchValue ||
                    cls.instructor_name.toLowerCase().includes(searchValue) ||
                    cls.course.toLowerCase().includes(searchValue) ||
                    cls.class_display_id.toLowerCase().includes(searchValue) ||
                    cls.department.toLowerCase().includes(searchValue);

                return statusMatch && searchMatch;
            });

            displayGradeReleaseClasses(filteredGradeReleaseData);
        }

        function refreshGradeReleaseData() {
            loadGradeReleaseData();
            showNotification('Grade release data refreshed', 'success');
        }

        // ==========================================
        // CLASS OVERVIEW SYSTEM
        // ==========================================

        function openClassOverviewModal() {
            document.getElementById('classOverviewModal').style.display = 'block';
            loadClassOverview();
        }

        function closeClassOverviewModal() {
            document.getElementById('classOverviewModal').style.display = 'none';
        }

        function loadClassOverview() {
            document.getElementById('classOverviewContent').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p>Loading class overview...</p>
                </div>
            `;

            fetch('/api/admin/class-overview')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayClassOverview(data);
                    } else {
                        document.getElementById('classOverviewContent').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #dc2626;">
                                <p>‚ùå Failed to load class overview</p>
                                <p>${data.error}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading class overview:', error);
                    document.getElementById('classOverviewContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc2626;">
                            <p>‚ùå Error loading class overview</p>
                        </div>
                    `;
                });
        }

        function displayClassOverview(data) {
            const content = document.getElementById('classOverviewContent');

            content.innerHTML = `
                <!-- Summary Statistics -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${data.summary.total_classes}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Classes</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${data.summary.total_students}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Students</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${data.summary.avg_students_per_class}</div>
                        <div style="font-size: 14px; opacity: 0.9;">Avg Students/Class</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;">${data.summary.avg_completion_percentage}%</div>
                        <div style="font-size: 14px; opacity: 0.9;">Avg Completion</div>
                    </div>
                </div>

                <!-- Classes per Semester -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #1f2937;">üìÖ Classes per Semester</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="semesterYearFilter" onchange="filterSemesterStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                <option value="">All Years</option>
                            </select>
                            <button onclick="resetSemesterFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Semester</th>
                                    <th style="padding: 12px; text-align: center;">Total Classes</th>
                                </tr>
                            </thead>
                            <tbody id="semesterTableBody">
                                ${data.semester_stats.map(stat => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;" data-year="${stat.semester_key.split(' - ')[0]}">
                                        <td style="padding: 12px; font-weight: 600; color: #1f2937;">${stat.semester_key}</td>
                                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea;">${stat.total_classes}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Classes by Department and Course -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #1f2937;">üè¢ Classes by Department</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="departmentSearch" placeholder="Search department..." oninput="filterDepartmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; width: 150px;">
                                <button onclick="resetDepartmentFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px; text-align: left;">Department</th>
                                        <th style="padding: 12px; text-align: center;">Classes</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentTableBody">
                                    ${data.department_stats.map(stat => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px; color: #1f2937;">${stat.department}</td>
                                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #f5576c;">${stat.total_classes}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #1f2937;">üìö Classes by Course</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="courseSearch" placeholder="Search course..." oninput="filterCourseStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; width: 150px;">
                                <button onclick="resetCourseFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 12px; text-align: left;">Course</th>
                                        <th style="padding: 12px; text-align: center;">Classes</th>
                                    </tr>
                                </thead>
                                <tbody id="courseTableBody">
                                    ${data.course_stats.map(stat => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;">
                                            <td style="padding: 12px; color: #1f2937;">${stat.course}</td>
                                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #00f2fe;">${stat.total_classes}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Class Details Tables -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #1f2937;">üìù Assessments per Class</h4>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <select id="assessmentYearFilter" onchange="filterAssessmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Years</option>
                                </select>
                                <select id="assessmentSemesterFilter" onchange="filterAssessmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Semesters</option>
                                </select>
                                <select id="assessmentStructureFilter" onchange="filterAssessmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Structures</option>
                                    <option value="Yes">Has Structure</option>
                                    <option value="No">No Structure</option>
                                </select>
                                <button onclick="resetAssessmentFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 8px; text-align: left;">Class</th>
                                        <th style="padding: 8px; text-align: center;">Assessments</th>
                                        <th style="padding: 8px; text-align: center;">Structure</th>
                                    </tr>
                                </thead>
                                <tbody id="assessmentTableBody">
                                    ${data.assessment_stats.map(stat => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;" data-year="${stat.year}" data-semester="${stat.semester}" data-structure="${stat.has_structure}">
                                            <td style="padding: 8px; color: #1f2937; font-size: 12px;">
                                                ${stat.year} ${stat.semester} ${stat.course} ${stat.section}
                                            </td>
                                            <td style="padding: 8px; text-align: center; font-weight: bold; color: #38f9d7;">${stat.assessment_count}</td>
                                            <td style="padding: 8px; text-align: center;">
                                                <span class="status-badge status-${stat.has_structure === 'Yes' ? 'active' : 'suspended'}">
                                                    ${stat.has_structure}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #1f2937;">üë• Students Enrolled per Class</h4>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <select id="enrollmentYearFilter" onchange="filterEnrollmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Years</option>
                                </select>
                                <select id="enrollmentSemesterFilter" onchange="filterEnrollmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Semesters</option>
                                </select>
                                <select id="enrollmentRangeFilter" onchange="filterEnrollmentStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                    <option value="">All Ranges</option>
                                    <option value="0-10">0-10 students</option>
                                    <option value="11-25">11-25 students</option>
                                    <option value="26-50">26-50 students</option>
                                    <option value="51+">51+ students</option>
                                </select>
                                <button onclick="resetEnrollmentFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                            </div>
                        </div>
                        <div style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 8px; text-align: left;">Class</th>
                                        <th style="padding: 8px; text-align: center;">Enrolled</th>
                                    </tr>
                                </thead>
                                <tbody id="enrollmentTableBody">
                                    ${data.enrollment_stats.map(stat => `
                                        <tr style="border-bottom: 1px solid #e5e7eb;" data-year="${stat.year}" data-semester="${stat.semester}" data-enrolled="${stat.enrolled_students}">
                                            <td style="padding: 8px; color: #1f2937; font-size: 12px;">
                                                ${stat.year} ${stat.semester} ${stat.course} ${stat.section}
                                            </td>
                                            <td style="padding: 8px; text-align: center; font-weight: bold; color: #764ba2;">${stat.enrolled_students}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Grading Structure Completion -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #1f2937;">‚úÖ Grading Structure Completion</h4>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="completionYearFilter" onchange="filterCompletionStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                <option value="">All Years</option>
                            </select>
                            <select id="completionSemesterFilter" onchange="filterCompletionStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                <option value="">All Semesters</option>
                            </select>
                            <select id="completionStatusFilter" onchange="filterCompletionStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                <option value="">All Statuses</option>
                                <option value="Complete">Complete</option>
                                <option value="Assessments Missing">Assessments Missing</option>
                                <option value="Subcategories Missing">Subcategories Missing</option>
                                <option value="Categories Missing">Categories Missing</option>
                                <option value="No Structure">No Structure</option>
                            </select>
                            <select id="completionRangeFilter" onchange="filterCompletionStats()" style="padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px;">
                                <option value="">All Ranges</option>
                                <option value="0-25">0-25%</option>
                                <option value="26-50">26-50%</option>
                                <option value="51-75">51-75%</option>
                                <option value="76-99">76-99%</option>
                                <option value="100">100%</option>
                            </select>
                            <button onclick="resetCompletionFilter()" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 5px; font-size: 12px; cursor: pointer;">Reset</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 12px; text-align: left;">Class</th>
                                    <th style="padding: 12px; text-align: center;">Completion %</th>
                                    <th style="padding: 12px; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="completionTableBody">
                                ${data.completion_stats.map(stat => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;" data-year="${stat.year}" data-semester="${stat.semester}" data-status="${stat.completion_status}" data-percentage="${stat.completion_percentage}">
                                        <td style="padding: 12px; color: #1f2937;">
                                            ${stat.year} ${stat.semester} ${stat.course} ${stat.section}
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <div style="display: flex; align-items: center; gap: 10px;">
                                                <div style="flex: 1; background: #e5e7eb; height: 8px; border-radius: 4px;">
                                                    <div style="background: ${stat.completion_percentage === 100 ? '#10b981' : stat.completion_percentage >= 75 ? '#f59e0b' : '#ef4444'}; height: 100%; border-radius: 4px; width: ${stat.completion_percentage}%;"></div>
                                                </div>
                                                <span style="font-weight: bold; min-width: 35px;">${stat.completion_percentage}%</span>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span class="status-badge status-${stat.completion_percentage === 100 ? 'active' : stat.completion_percentage >= 75 ? 'suspended' : 'suspended'}">
                                                ${stat.completion_status}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    </script>

</body>
    <script type="module" src="{{ url_for('static', filename='js/ngrokFetch.js') }}"></script>

</html>
